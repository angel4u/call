{"ast":null,"code":"'use strict';\n\nvar EventEmitter = require('events').EventEmitter;\n\nvar request = require('./request');\n\nvar util = require('util');\n/**\n * Builds Endpoint Analytics (EA) event payloads and sends them to\n *   the EA server.\n * @constructor\n * @param {String} productName - Name of the product publishing events.\n * @param {String} token - The JWT token to use to authenticate with\n *   the EA server.\n * @param {EventPublisher.Options} options\n * @property {Boolean} isEnabled - Whether or not this publisher is publishing\n *   to the server. Currently ignores the request altogether, in the future this\n *   may store them in case publishing is re-enabled later. Defaults to true.\n */\n\n/**\n* @typedef {Object} EventPublisher.Options\n* @property {Object} [metadata=undefined] - A publisher_metadata object to send\n*   with each payload.\n* @property {String} [host='eventgw.twilio.com'] - The host address of the EA\n*   server to publish to.\n* @property {Object|Function} [defaultPayload] - A default payload to extend\n*   when creating and sending event payloads. Also takes a function that\n*   should return an object representing the default payload. This is\n*   useful for fields that should always be present when they are\n*   available, but are not always available.\n*/\n\n\nfunction EventPublisher(productName, token, options) {\n  if (!(this instanceof EventPublisher)) {\n    return new EventPublisher(productName, token, options);\n  } // Apply default options\n\n\n  options = Object.assign({\n    defaultPayload: function defaultPayload() {\n      return {};\n    },\n    host: 'eventgw.twilio.com'\n  }, options);\n  var defaultPayload = options.defaultPayload;\n\n  if (typeof defaultPayload !== 'function') {\n    defaultPayload = function defaultPayload() {\n      return Object.assign({}, options.defaultPayload);\n    };\n  }\n\n  var isEnabled = true; // eslint-disable-next-line camelcase,no-undefined\n\n  var metadata = Object.assign({\n    app_name: undefined,\n    app_version: undefined\n  }, options.metadata);\n  Object.defineProperties(this, {\n    _defaultPayload: {\n      value: defaultPayload\n    },\n    _isEnabled: {\n      get: function get() {\n        return isEnabled;\n      },\n      set: function set(_isEnabled) {\n        isEnabled = _isEnabled;\n      }\n    },\n    _host: {\n      value: options.host\n    },\n    _request: {\n      value: options.request || request,\n      writable: true\n    },\n    _token: {\n      value: token,\n      writable: true\n    },\n    isEnabled: {\n      enumerable: true,\n      get: function get() {\n        return isEnabled;\n      }\n    },\n    metadata: {\n      enumerable: true,\n      get: function get() {\n        return metadata;\n      }\n    },\n    productName: {\n      enumerable: true,\n      value: productName\n    },\n    token: {\n      enumerable: true,\n      get: function get() {\n        return this._token;\n      }\n    }\n  });\n}\n\nutil.inherits(EventPublisher, EventEmitter);\n/**\n * Post to an EA server.\n * @private\n * @param {String} endpointName - Endpoint to post the event to\n * @param {String} level - ['debug', 'info', 'warning', 'error']\n * @param {String} group - The name of the group the event belongs to.\n * @param {String} name - The designated event name.\n * @param {?Object} [payload=null] - The payload to pass. This will be extended\n *    onto the default payload object, if one exists.\n * @param {?Connection} [connection=null] - The {@link Connection} which is posting this payload.\n * @param {?Boolean} [force=false] - Whether or not to send this even if\n *    publishing is disabled.\n * @returns {Promise} Fulfilled if the HTTP response is 20x.\n */\n\nEventPublisher.prototype._post = function _post(endpointName, level, group, name, payload, connection, force) {\n  var _this = this;\n\n  if (!this.isEnabled && !force) {\n    return Promise.resolve();\n  }\n\n  if (!connection || (!connection.parameters || !connection.parameters.CallSid) && !connection.outboundConnectionId) {\n    return Promise.resolve();\n  }\n\n  var event = {\n    /* eslint-disable camelcase */\n    publisher: this.productName,\n    group: group,\n    name: name,\n    timestamp: new Date().toISOString(),\n    level: level.toUpperCase(),\n    payload_type: 'application/json',\n    private: false,\n    payload: payload && payload.forEach ? payload.slice(0) : Object.assign(this._defaultPayload(connection), payload)\n    /* eslint-enable camelcase */\n\n  };\n\n  if (this.metadata) {\n    // eslint-disable-next-line camelcase\n    event.publisher_metadata = this.metadata;\n  }\n\n  var requestParams = {\n    url: 'https://' + this._host + '/v4/' + endpointName,\n    body: event,\n    headers: {\n      'Content-Type': 'application/json',\n      'X-Twilio-Token': this.token\n    }\n  };\n  var self = this;\n  return new Promise(function (resolve, reject) {\n    self._request.post(requestParams, function (err) {\n      if (err) {\n        _this.emit('error', err);\n\n        reject(err);\n      } else {\n        resolve();\n      }\n    });\n  });\n};\n/**\n * Post an event to the EA server. Use this method when the level\n *  is dynamic. Otherwise, it's better practice to use the sugar\n *  methods named for the specific level.\n * @param {String} level - ['debug', 'info', 'warning', 'error']\n * @param {String} group - The name of the group the event belongs to.\n * @param {String} name - The designated event name.\n * @param {?Object} [payload=null] - The payload to pass. This will be extended\n *    onto the default payload object, if one exists.\n * @param {?Connection} [connection=null] - The {@link Connection} which is posting this payload.\n * @returns {Promise} Fulfilled if the HTTP response is 20x.\n */\n\n\nEventPublisher.prototype.post = function post(level, group, name, payload, connection, force) {\n  return this._post('EndpointEvents', level, group, name, payload, connection, force);\n};\n/**\n * Post a debug-level event to the EA server.\n * @param {String} group - The name of the group the event belongs to.\n * @param {String} name - The designated event name.\n * @param {?Object} [payload=null] - The payload to pass. This will be extended\n *    onto the default payload object, if one exists.\n * @param {?Connection} [connection=null] - The {@link Connection} which is posting this payload.\n * @returns {Promise} Fulfilled if the HTTP response is 20x.\n */\n\n\nEventPublisher.prototype.debug = function debug(group, name, payload, connection) {\n  return this.post('debug', group, name, payload, connection);\n};\n/**\n * Post an info-level event to the EA server.\n * @param {String} group - The name of the group the event belongs to.\n * @param {String} name - The designated event name.\n * @param {?Object} [payload=null] - The payload to pass. This will be extended\n *    onto the default payload object, if one exists.\n * @param {?Connection} [connection=null] - The {@link Connection} which is posting this payload.\n * @returns {Promise} Fulfilled if the HTTP response is 20x.\n */\n\n\nEventPublisher.prototype.info = function info(group, name, payload, connection) {\n  return this.post('info', group, name, payload, connection);\n};\n/**\n * Post a warning-level event to the EA server.\n * @param {String} group - The name of the group the event belongs to.\n * @param {String} name - The designated event name.\n * @param {?Object} [payload=null] - The payload to pass. This will be extended\n *    onto the default payload object, if one exists.\n * @param {?Connection} [connection=null] - The {@link Connection} which is posting this payload.\n * @returns {Promise} Fulfilled if the HTTP response is 20x.\n */\n\n\nEventPublisher.prototype.warn = function warn(group, name, payload, connection) {\n  return this.post('warning', group, name, payload, connection);\n};\n/**\n * Post an error-level event to the EA server.\n * @param {String} group - The name of the group the event belongs to.\n * @param {String} name - The designated event name.\n * @param {?Object} [payload=null] - The payload to pass. This will be extended\n *    onto the default payload object, if one exists.\n * @param {?Connection} [connection=null] - The {@link Connection} which is posting this payload.\n * @returns {Promise} Fulfilled if the HTTP response is 20x.\n */\n\n\nEventPublisher.prototype.error = function error(group, name, payload, connection) {\n  return this.post('error', group, name, payload, connection);\n};\n/**\n * Post a metrics event to the EA server.\n * @param {String} group - The name of the group the event belongs to.\n * @param {String} name - The designated event name.\n * @param {Array<Object>} metrics - The metrics to post.\n * @param {?Object} [customFields] - Custom fields to append to each payload.\n * @returns {Promise} Fulfilled if the HTTP response is 20x.\n */\n\n\nEventPublisher.prototype.postMetrics = function postMetrics(group, name, metrics, customFields, connection) {\n  var _this2 = this;\n\n  return new Promise(function (resolve) {\n    var samples = metrics.map(formatMetric).map(function (sample) {\n      return Object.assign(sample, customFields);\n    });\n    resolve(_this2._post('EndpointMetrics', 'info', group, name, samples, connection));\n  });\n};\n/**\n * Update the token to use to authenticate requests.\n * @param {string} token\n * @returns {void}\n */\n\n\nEventPublisher.prototype.setToken = function setToken(token) {\n  this._token = token;\n};\n/**\n * Enable the publishing of events.\n */\n\n\nEventPublisher.prototype.enable = function enable() {\n  this._isEnabled = true;\n};\n/**\n * Disable the publishing of events.\n */\n\n\nEventPublisher.prototype.disable = function disable() {\n  this._isEnabled = false;\n};\n\nfunction formatMetric(sample) {\n  return {\n    /* eslint-disable camelcase */\n    timestamp: new Date(sample.timestamp).toISOString(),\n    total_packets_received: sample.totals.packetsReceived,\n    total_packets_lost: sample.totals.packetsLost,\n    total_packets_sent: sample.totals.packetsSent,\n    total_bytes_received: sample.totals.bytesReceived,\n    total_bytes_sent: sample.totals.bytesSent,\n    packets_received: sample.packetsReceived,\n    packets_lost: sample.packetsLost,\n    packets_lost_fraction: sample.packetsLostFraction && Math.round(sample.packetsLostFraction * 100) / 100,\n    bytes_received: sample.bytesReceived,\n    bytes_sent: sample.bytesSent,\n    audio_codec: sample.codecName,\n    audio_level_in: sample.audioInputLevel,\n    audio_level_out: sample.audioOutputLevel,\n    call_volume_input: sample.inputVolume,\n    call_volume_output: sample.outputVolume,\n    jitter: sample.jitter,\n    rtt: sample.rtt,\n    mos: sample.mos && Math.round(sample.mos * 100) / 100\n    /* eslint-enable camelcase */\n\n  };\n}\n\nmodule.exports = EventPublisher;","map":{"version":3,"sources":["/root/twilio-phone-client/node_modules/twilio-client/es5/twilio/eventpublisher.js"],"names":["EventEmitter","require","request","util","EventPublisher","productName","token","options","Object","assign","defaultPayload","host","isEnabled","metadata","app_name","undefined","app_version","defineProperties","_defaultPayload","value","_isEnabled","get","set","_host","_request","writable","_token","enumerable","inherits","prototype","_post","endpointName","level","group","name","payload","connection","force","_this","Promise","resolve","parameters","CallSid","outboundConnectionId","event","publisher","timestamp","Date","toISOString","toUpperCase","payload_type","private","forEach","slice","publisher_metadata","requestParams","url","body","headers","self","reject","post","err","emit","debug","info","warn","error","postMetrics","metrics","customFields","_this2","samples","map","formatMetric","sample","setToken","enable","disable","total_packets_received","totals","packetsReceived","total_packets_lost","packetsLost","total_packets_sent","packetsSent","total_bytes_received","bytesReceived","total_bytes_sent","bytesSent","packets_received","packets_lost","packets_lost_fraction","packetsLostFraction","Math","round","bytes_received","bytes_sent","audio_codec","codecName","audio_level_in","audioInputLevel","audio_level_out","audioOutputLevel","call_volume_input","inputVolume","call_volume_output","outputVolume","jitter","rtt","mos","module","exports"],"mappings":"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","sourcesContent":["'use strict';\n\nvar EventEmitter = require('events').EventEmitter;\nvar request = require('./request');\nvar util = require('util');\n\n/**\n * Builds Endpoint Analytics (EA) event payloads and sends them to\n *   the EA server.\n * @constructor\n * @param {String} productName - Name of the product publishing events.\n * @param {String} token - The JWT token to use to authenticate with\n *   the EA server.\n * @param {EventPublisher.Options} options\n * @property {Boolean} isEnabled - Whether or not this publisher is publishing\n *   to the server. Currently ignores the request altogether, in the future this\n *   may store them in case publishing is re-enabled later. Defaults to true.\n */ /**\n    * @typedef {Object} EventPublisher.Options\n    * @property {Object} [metadata=undefined] - A publisher_metadata object to send\n    *   with each payload.\n    * @property {String} [host='eventgw.twilio.com'] - The host address of the EA\n    *   server to publish to.\n    * @property {Object|Function} [defaultPayload] - A default payload to extend\n    *   when creating and sending event payloads. Also takes a function that\n    *   should return an object representing the default payload. This is\n    *   useful for fields that should always be present when they are\n    *   available, but are not always available.\n    */\nfunction EventPublisher(productName, token, options) {\n  if (!(this instanceof EventPublisher)) {\n    return new EventPublisher(productName, token, options);\n  }\n\n  // Apply default options\n  options = Object.assign({\n    defaultPayload: function defaultPayload() {\n      return {};\n    },\n\n    host: 'eventgw.twilio.com'\n  }, options);\n\n  var defaultPayload = options.defaultPayload;\n\n  if (typeof defaultPayload !== 'function') {\n    defaultPayload = function defaultPayload() {\n      return Object.assign({}, options.defaultPayload);\n    };\n  }\n\n  var isEnabled = true;\n  // eslint-disable-next-line camelcase,no-undefined\n  var metadata = Object.assign({ app_name: undefined, app_version: undefined }, options.metadata);\n\n  Object.defineProperties(this, {\n    _defaultPayload: { value: defaultPayload },\n    _isEnabled: {\n      get: function get() {\n        return isEnabled;\n      },\n      set: function set(_isEnabled) {\n        isEnabled = _isEnabled;\n      }\n    },\n    _host: { value: options.host },\n    _request: { value: options.request || request, writable: true },\n    _token: { value: token, writable: true },\n    isEnabled: {\n      enumerable: true,\n      get: function get() {\n        return isEnabled;\n      }\n    },\n    metadata: {\n      enumerable: true,\n      get: function get() {\n        return metadata;\n      }\n    },\n    productName: { enumerable: true, value: productName },\n    token: {\n      enumerable: true,\n      get: function get() {\n        return this._token;\n      }\n    }\n  });\n}\n\nutil.inherits(EventPublisher, EventEmitter);\n\n/**\n * Post to an EA server.\n * @private\n * @param {String} endpointName - Endpoint to post the event to\n * @param {String} level - ['debug', 'info', 'warning', 'error']\n * @param {String} group - The name of the group the event belongs to.\n * @param {String} name - The designated event name.\n * @param {?Object} [payload=null] - The payload to pass. This will be extended\n *    onto the default payload object, if one exists.\n * @param {?Connection} [connection=null] - The {@link Connection} which is posting this payload.\n * @param {?Boolean} [force=false] - Whether or not to send this even if\n *    publishing is disabled.\n * @returns {Promise} Fulfilled if the HTTP response is 20x.\n */\nEventPublisher.prototype._post = function _post(endpointName, level, group, name, payload, connection, force) {\n  var _this = this;\n\n  if (!this.isEnabled && !force) {\n    return Promise.resolve();\n  }\n\n  if (!connection || (!connection.parameters || !connection.parameters.CallSid) && !connection.outboundConnectionId) {\n    return Promise.resolve();\n  }\n\n  var event = {\n    /* eslint-disable camelcase */\n    publisher: this.productName,\n    group: group,\n    name: name,\n    timestamp: new Date().toISOString(),\n    level: level.toUpperCase(),\n    payload_type: 'application/json',\n    private: false,\n    payload: payload && payload.forEach ? payload.slice(0) : Object.assign(this._defaultPayload(connection), payload)\n    /* eslint-enable camelcase */\n  };\n\n  if (this.metadata) {\n    // eslint-disable-next-line camelcase\n    event.publisher_metadata = this.metadata;\n  }\n\n  var requestParams = {\n    url: 'https://' + this._host + '/v4/' + endpointName,\n    body: event,\n    headers: {\n      'Content-Type': 'application/json',\n      'X-Twilio-Token': this.token\n    }\n  };\n\n  var self = this;\n  return new Promise(function (resolve, reject) {\n    self._request.post(requestParams, function (err) {\n      if (err) {\n        _this.emit('error', err);\n        reject(err);\n      } else {\n        resolve();\n      }\n    });\n  });\n};\n\n/**\n * Post an event to the EA server. Use this method when the level\n *  is dynamic. Otherwise, it's better practice to use the sugar\n *  methods named for the specific level.\n * @param {String} level - ['debug', 'info', 'warning', 'error']\n * @param {String} group - The name of the group the event belongs to.\n * @param {String} name - The designated event name.\n * @param {?Object} [payload=null] - The payload to pass. This will be extended\n *    onto the default payload object, if one exists.\n * @param {?Connection} [connection=null] - The {@link Connection} which is posting this payload.\n * @returns {Promise} Fulfilled if the HTTP response is 20x.\n */\nEventPublisher.prototype.post = function post(level, group, name, payload, connection, force) {\n  return this._post('EndpointEvents', level, group, name, payload, connection, force);\n};\n\n/**\n * Post a debug-level event to the EA server.\n * @param {String} group - The name of the group the event belongs to.\n * @param {String} name - The designated event name.\n * @param {?Object} [payload=null] - The payload to pass. This will be extended\n *    onto the default payload object, if one exists.\n * @param {?Connection} [connection=null] - The {@link Connection} which is posting this payload.\n * @returns {Promise} Fulfilled if the HTTP response is 20x.\n */\nEventPublisher.prototype.debug = function debug(group, name, payload, connection) {\n  return this.post('debug', group, name, payload, connection);\n};\n\n/**\n * Post an info-level event to the EA server.\n * @param {String} group - The name of the group the event belongs to.\n * @param {String} name - The designated event name.\n * @param {?Object} [payload=null] - The payload to pass. This will be extended\n *    onto the default payload object, if one exists.\n * @param {?Connection} [connection=null] - The {@link Connection} which is posting this payload.\n * @returns {Promise} Fulfilled if the HTTP response is 20x.\n */\nEventPublisher.prototype.info = function info(group, name, payload, connection) {\n  return this.post('info', group, name, payload, connection);\n};\n\n/**\n * Post a warning-level event to the EA server.\n * @param {String} group - The name of the group the event belongs to.\n * @param {String} name - The designated event name.\n * @param {?Object} [payload=null] - The payload to pass. This will be extended\n *    onto the default payload object, if one exists.\n * @param {?Connection} [connection=null] - The {@link Connection} which is posting this payload.\n * @returns {Promise} Fulfilled if the HTTP response is 20x.\n */\nEventPublisher.prototype.warn = function warn(group, name, payload, connection) {\n  return this.post('warning', group, name, payload, connection);\n};\n\n/**\n * Post an error-level event to the EA server.\n * @param {String} group - The name of the group the event belongs to.\n * @param {String} name - The designated event name.\n * @param {?Object} [payload=null] - The payload to pass. This will be extended\n *    onto the default payload object, if one exists.\n * @param {?Connection} [connection=null] - The {@link Connection} which is posting this payload.\n * @returns {Promise} Fulfilled if the HTTP response is 20x.\n */\nEventPublisher.prototype.error = function error(group, name, payload, connection) {\n  return this.post('error', group, name, payload, connection);\n};\n\n/**\n * Post a metrics event to the EA server.\n * @param {String} group - The name of the group the event belongs to.\n * @param {String} name - The designated event name.\n * @param {Array<Object>} metrics - The metrics to post.\n * @param {?Object} [customFields] - Custom fields to append to each payload.\n * @returns {Promise} Fulfilled if the HTTP response is 20x.\n */\nEventPublisher.prototype.postMetrics = function postMetrics(group, name, metrics, customFields, connection) {\n  var _this2 = this;\n\n  return new Promise(function (resolve) {\n    var samples = metrics.map(formatMetric).map(function (sample) {\n      return Object.assign(sample, customFields);\n    });\n\n    resolve(_this2._post('EndpointMetrics', 'info', group, name, samples, connection));\n  });\n};\n\n/**\n * Update the token to use to authenticate requests.\n * @param {string} token\n * @returns {void}\n */\nEventPublisher.prototype.setToken = function setToken(token) {\n  this._token = token;\n};\n\n/**\n * Enable the publishing of events.\n */\nEventPublisher.prototype.enable = function enable() {\n  this._isEnabled = true;\n};\n\n/**\n * Disable the publishing of events.\n */\nEventPublisher.prototype.disable = function disable() {\n  this._isEnabled = false;\n};\n\nfunction formatMetric(sample) {\n  return {\n    /* eslint-disable camelcase */\n    timestamp: new Date(sample.timestamp).toISOString(),\n    total_packets_received: sample.totals.packetsReceived,\n    total_packets_lost: sample.totals.packetsLost,\n    total_packets_sent: sample.totals.packetsSent,\n    total_bytes_received: sample.totals.bytesReceived,\n    total_bytes_sent: sample.totals.bytesSent,\n    packets_received: sample.packetsReceived,\n    packets_lost: sample.packetsLost,\n    packets_lost_fraction: sample.packetsLostFraction && Math.round(sample.packetsLostFraction * 100) / 100,\n    bytes_received: sample.bytesReceived,\n    bytes_sent: sample.bytesSent,\n    audio_codec: sample.codecName,\n    audio_level_in: sample.audioInputLevel,\n    audio_level_out: sample.audioOutputLevel,\n    call_volume_input: sample.inputVolume,\n    call_volume_output: sample.outputVolume,\n    jitter: sample.jitter,\n    rtt: sample.rtt,\n    mos: sample.mos && Math.round(sample.mos * 100) / 100\n    /* eslint-enable camelcase */\n  };\n}\n\nmodule.exports = EventPublisher;"]},"metadata":{},"sourceType":"script"}