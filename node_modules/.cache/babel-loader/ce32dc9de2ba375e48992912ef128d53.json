{"ast":null,"code":"'use strict';\n\nvar _require = require('../errors'),\n    InvalidArgumentError = _require.InvalidArgumentError,\n    MediaErrors = _require.MediaErrors,\n    NotSupportedError = _require.NotSupportedError,\n    SignalingErrors = _require.SignalingErrors;\n\nvar Log = require('../log').default;\n\nvar util = require('../util');\n\nvar RTCPC = require('./rtcpc');\n\nvar _require2 = require('./sdp'),\n    setIceAggressiveNomination = _require2.setIceAggressiveNomination;\n\nvar ICE_GATHERING_TIMEOUT = 15000;\nvar ICE_GATHERING_FAIL_NONE = 'none';\nvar ICE_GATHERING_FAIL_TIMEOUT = 'timeout';\nvar INITIAL_ICE_CONNECTION_STATE = 'new';\nvar VOLUME_INTERVAL_MS = 50;\n/**\n * @typedef {Object} PeerConnection\n * @param audioHelper\n * @param pstream\n * @param options\n * @return {PeerConnection}\n * @constructor\n */\n\nfunction PeerConnection(audioHelper, pstream, getUserMedia, options) {\n  if (!audioHelper || !pstream || !getUserMedia) {\n    throw new InvalidArgumentError('Audiohelper, pstream and getUserMedia are required arguments');\n  }\n\n  if (!(this instanceof PeerConnection)) {\n    return new PeerConnection(audioHelper, pstream, getUserMedia, options);\n  }\n\n  function noop() {}\n\n  this.onopen = noop;\n  this.onerror = noop;\n  this.onclose = noop;\n  this.ondisconnected = noop;\n  this.onfailed = noop;\n  this.onconnected = noop;\n  this.onreconnected = noop;\n  this.onsignalingstatechange = noop;\n  this.ondtlstransportstatechange = noop;\n  this.onicegatheringfailure = noop;\n  this.onicegatheringstatechange = noop;\n  this.oniceconnectionstatechange = noop;\n  this.onpcconnectionstatechange = noop;\n  this.onicecandidate = noop;\n  this.onselectedcandidatepairchange = noop;\n  this.onvolume = noop;\n  this.version = null;\n  this.pstream = pstream;\n  this.stream = null;\n  this.sinkIds = new Set(['default']);\n  this.outputs = new Map();\n  this.status = 'connecting';\n  this.callSid = null;\n  this.isMuted = false;\n  this.getUserMedia = getUserMedia;\n  var AudioContext = typeof window !== 'undefined' && (window.AudioContext || window.webkitAudioContext);\n  this._isSinkSupported = !!AudioContext && typeof HTMLAudioElement !== 'undefined' && HTMLAudioElement.prototype.setSinkId; // NOTE(mmalavalli): Since each Connection creates its own AudioContext,\n  // after 6 instances an exception is thrown. Refer https://www.w3.org/2011/audio/track/issues/3.\n  // In order to get around it, we are re-using the Device's AudioContext.\n\n  this._audioContext = AudioContext && audioHelper._audioContext;\n  this._hasIceCandidates = false;\n  this._hasIceGatheringFailures = false;\n  this._iceGatheringTimeoutId = null;\n  this._masterAudio = null;\n  this._masterAudioDeviceId = null;\n  this._mediaStreamSource = null;\n  this._dtmfSender = null;\n  this._dtmfSenderUnsupported = false;\n  this._callEvents = [];\n  this._nextTimeToPublish = Date.now();\n  this._onAnswerOrRinging = noop;\n  this._onHangup = noop;\n  this._remoteStream = null;\n  this._shouldManageStream = true;\n  this._iceState = INITIAL_ICE_CONNECTION_STATE;\n  this._isUnifiedPlan = options.isUnifiedPlan;\n  this.options = options = options || {};\n  this.navigator = options.navigator || (typeof navigator !== 'undefined' ? navigator : null);\n  this.util = options.util || util;\n  this.codecPreferences = options.codecPreferences;\n  this._log = Log.getInstance();\n  return this;\n}\n\nPeerConnection.prototype.uri = function () {\n  return this._uri;\n};\n/**\n * Open the underlying RTCPeerConnection with a MediaStream obtained by\n *   passed constraints. The resulting MediaStream is created internally\n *   and will therefore be managed and destroyed internally.\n * @param {MediaStreamConstraints} constraints\n */\n\n\nPeerConnection.prototype.openWithConstraints = function (constraints) {\n  return this.getUserMedia({\n    audio: constraints\n  }).then(this._setInputTracksFromStream.bind(this, false));\n};\n/**\n * Replace the existing input audio tracks with the audio tracks from the\n *   passed input audio stream. We re-use the existing stream because\n *   the AnalyzerNode is bound to the stream.\n * @param {MediaStream} stream\n */\n\n\nPeerConnection.prototype.setInputTracksFromStream = function (stream) {\n  var self = this;\n  return this._setInputTracksFromStream(true, stream).then(function () {\n    self._shouldManageStream = false;\n  });\n};\n\nPeerConnection.prototype._createAnalyser = function (audioContext, options) {\n  options = Object.assign({\n    fftSize: 32,\n    smoothingTimeConstant: 0.3\n  }, options);\n  var analyser = audioContext.createAnalyser();\n\n  for (var field in options) {\n    analyser[field] = options[field];\n  }\n\n  return analyser;\n};\n\nPeerConnection.prototype._setVolumeHandler = function (handler) {\n  this.onvolume = handler;\n};\n\nPeerConnection.prototype._startPollingVolume = function () {\n  if (!this._audioContext || !this.stream || !this._remoteStream) {\n    return;\n  }\n\n  var audioContext = this._audioContext;\n\n  var inputAnalyser = this._inputAnalyser = this._createAnalyser(audioContext);\n\n  var inputBufferLength = inputAnalyser.frequencyBinCount;\n  var inputDataArray = new Uint8Array(inputBufferLength);\n  this._inputAnalyser2 = this._createAnalyser(audioContext, {\n    minDecibels: -127,\n    maxDecibels: 0,\n    smoothingTimeConstant: 0\n  });\n\n  var outputAnalyser = this._outputAnalyser = this._createAnalyser(audioContext);\n\n  var outputBufferLength = outputAnalyser.frequencyBinCount;\n  var outputDataArray = new Uint8Array(outputBufferLength);\n  this._outputAnalyser2 = this._createAnalyser(audioContext, {\n    minDecibels: -127,\n    maxDecibels: 0,\n    smoothingTimeConstant: 0\n  });\n\n  this._updateInputStreamSource(this.stream);\n\n  this._updateOutputStreamSource(this._remoteStream);\n\n  var self = this;\n  setTimeout(function emitVolume() {\n    if (!self._audioContext) {\n      return;\n    } else if (self.status === 'closed') {\n      self._inputAnalyser.disconnect();\n\n      self._outputAnalyser.disconnect();\n\n      self._inputAnalyser2.disconnect();\n\n      self._outputAnalyser2.disconnect();\n\n      return;\n    }\n\n    self._inputAnalyser.getByteFrequencyData(inputDataArray);\n\n    var inputVolume = self.util.average(inputDataArray);\n\n    self._inputAnalyser2.getByteFrequencyData(inputDataArray);\n\n    var inputVolume2 = self.util.average(inputDataArray);\n\n    self._outputAnalyser.getByteFrequencyData(outputDataArray);\n\n    var outputVolume = self.util.average(outputDataArray);\n\n    self._outputAnalyser2.getByteFrequencyData(outputDataArray);\n\n    var outputVolume2 = self.util.average(outputDataArray);\n    self.onvolume(inputVolume / 255, outputVolume / 255, inputVolume2, outputVolume2);\n    setTimeout(emitVolume, VOLUME_INTERVAL_MS);\n  }, VOLUME_INTERVAL_MS);\n};\n\nPeerConnection.prototype._stopStream = function _stopStream(stream) {\n  // We shouldn't stop the tracks if they were not created inside\n  //   this PeerConnection.\n  if (!this._shouldManageStream) {\n    return;\n  }\n\n  if (typeof MediaStreamTrack.prototype.stop === 'function') {\n    var audioTracks = typeof stream.getAudioTracks === 'function' ? stream.getAudioTracks() : stream.audioTracks;\n    audioTracks.forEach(function (track) {\n      track.stop();\n    });\n  } // NOTE(mroberts): This is just a fallback to any ancient browsers that may\n  // not implement MediaStreamTrack.stop.\n  else {\n      stream.stop();\n    }\n};\n/**\n * Update the stream source with the new input audio stream.\n * @param {MediaStream} stream\n * @private\n */\n\n\nPeerConnection.prototype._updateInputStreamSource = function (stream) {\n  if (this._inputStreamSource) {\n    this._inputStreamSource.disconnect();\n  }\n\n  this._inputStreamSource = this._audioContext.createMediaStreamSource(stream);\n\n  this._inputStreamSource.connect(this._inputAnalyser);\n\n  this._inputStreamSource.connect(this._inputAnalyser2);\n};\n/**\n * Update the stream source with the new ouput audio stream.\n * @param {MediaStream} stream\n * @private\n */\n\n\nPeerConnection.prototype._updateOutputStreamSource = function (stream) {\n  if (this._outputStreamSource) {\n    this._outputStreamSource.disconnect();\n  }\n\n  this._outputStreamSource = this._audioContext.createMediaStreamSource(stream);\n\n  this._outputStreamSource.connect(this._outputAnalyser);\n\n  this._outputStreamSource.connect(this._outputAnalyser2);\n};\n/**\n * Replace the tracks of the current stream with new tracks. We do this rather than replacing the\n *   whole stream because AnalyzerNodes are bound to a stream.\n * @param {Boolean} shouldClone - Whether the stream should be cloned if it is the first\n *   stream, or set directly. As a rule of thumb, streams that are passed in externally may have\n *   their lifecycle managed externally, and should be cloned so that we do not tear it or its tracks\n *   down when the call ends. Streams that we create internally (inside PeerConnection) should be set\n *   directly so that when the call ends it is disposed of.\n * @param {MediaStream} newStream - The new stream to copy the tracks over from.\n * @private\n */\n\n\nPeerConnection.prototype._setInputTracksFromStream = function (shouldClone, newStream) {\n  return this._isUnifiedPlan ? this._setInputTracksForUnifiedPlan(shouldClone, newStream) : this._setInputTracksForPlanB(shouldClone, newStream);\n};\n/**\n * Replace the tracks of the current stream with new tracks using the 'plan-b' method.\n * @param {Boolean} shouldClone - Whether the stream should be cloned if it is the first\n *   stream, or set directly. As a rule of thumb, streams that are passed in externally may have\n *   their lifecycle managed externally, and should be cloned so that we do not tear it or its tracks\n *   down when the call ends. Streams that we create internally (inside PeerConnection) should be set\n *   directly so that when the call ends it is disposed of.\n * @param {MediaStream} newStream - The new stream to copy the tracks over from.\n * @private\n */\n\n\nPeerConnection.prototype._setInputTracksForPlanB = function (shouldClone, newStream) {\n  var _this = this;\n\n  if (!newStream) {\n    return Promise.reject(new InvalidArgumentError('Can not set input stream to null while in a call'));\n  }\n\n  if (!newStream.getAudioTracks().length) {\n    return Promise.reject(new InvalidArgumentError('Supplied input stream has no audio tracks'));\n  }\n\n  var localStream = this.stream;\n\n  if (!localStream) {\n    // We can't use MediaStream.clone() here because it stopped copying over tracks\n    //   as of Chrome 61. https://bugs.chromium.org/p/chromium/issues/detail?id=770908\n    this.stream = shouldClone ? cloneStream(newStream) : newStream;\n  } else {\n    this._stopStream(localStream);\n\n    removeStream(this.version.pc, localStream);\n    localStream.getAudioTracks().forEach(localStream.removeTrack, localStream);\n    newStream.getAudioTracks().forEach(localStream.addTrack, localStream);\n    addStream(this.version.pc, newStream);\n\n    this._updateInputStreamSource(this.stream);\n  } // Apply mute settings to new input track\n\n\n  this.mute(this.isMuted);\n\n  if (!this.version) {\n    return Promise.resolve(this.stream);\n  }\n\n  return new Promise(function (resolve, reject) {\n    _this.version.createOffer(_this.options.maxAverageBitrate, _this.codecPreferences, {\n      audio: true\n    }, function () {\n      _this.version.processAnswer(_this.codecPreferences, _this._answerSdp, function () {\n        resolve(_this.stream);\n      }, reject);\n    }, reject);\n  });\n};\n/**\n * Replace the tracks of the current stream with new tracks using the 'unified-plan' method.\n * @param {Boolean} shouldClone - Whether the stream should be cloned if it is the first\n *   stream, or set directly. As a rule of thumb, streams that are passed in externally may have\n *   their lifecycle managed externally, and should be cloned so that we do not tear it or its tracks\n *   down when the call ends. Streams that we create internally (inside PeerConnection) should be set\n *   directly so that when the call ends it is disposed of.\n * @param {MediaStream} newStream - The new stream to copy the tracks over from.\n * @private\n */\n\n\nPeerConnection.prototype._setInputTracksForUnifiedPlan = function (shouldClone, newStream) {\n  var _this2 = this;\n\n  if (!newStream) {\n    return Promise.reject(new InvalidArgumentError('Can not set input stream to null while in a call'));\n  }\n\n  if (!newStream.getAudioTracks().length) {\n    return Promise.reject(new InvalidArgumentError('Supplied input stream has no audio tracks'));\n  }\n\n  var localStream = this.stream;\n\n  var getStreamPromise = function getStreamPromise() {\n    // Apply mute settings to new input track\n    _this2.mute(_this2.isMuted);\n\n    return Promise.resolve(_this2.stream);\n  };\n\n  if (!localStream) {\n    // We can't use MediaStream.clone() here because it stopped copying over tracks\n    //   as of Chrome 61. https://bugs.chromium.org/p/chromium/issues/detail?id=770908\n    this.stream = shouldClone ? cloneStream(newStream) : newStream;\n  } else {\n    // If the call was started with gUM, and we are now replacing that track with an\n    // external stream's tracks, we should stop the old managed track.\n    if (this._shouldManageStream) {\n      this._stopStream(localStream);\n    }\n\n    if (!this._sender) {\n      this._sender = this.version.pc.getSenders()[0];\n    }\n\n    return this._sender.replaceTrack(newStream.getAudioTracks()[0]).then(function () {\n      _this2._updateInputStreamSource(newStream);\n\n      return getStreamPromise();\n    });\n  }\n\n  return getStreamPromise();\n};\n\nPeerConnection.prototype._onInputDevicesChanged = function () {\n  if (!this.stream) {\n    return;\n  } // If all of our active tracks are ended, then our active input was lost\n\n\n  var activeInputWasLost = this.stream.getAudioTracks().every(function (track) {\n    return track.readyState === 'ended';\n  }); // We only want to act if we manage the stream in PeerConnection (It was created\n  // here, rather than passed in.)\n\n  if (activeInputWasLost && this._shouldManageStream) {\n    this.openWithConstraints(true);\n  }\n};\n\nPeerConnection.prototype._onIceGatheringFailure = function (type) {\n  this._hasIceGatheringFailures = true;\n  this.onicegatheringfailure(type);\n};\n\nPeerConnection.prototype._onMediaConnectionStateChange = function (newState) {\n  var previousState = this._iceState;\n\n  if (previousState === newState || newState !== 'connected' && newState !== 'disconnected' && newState !== 'failed') {\n    return;\n  }\n\n  this._iceState = newState;\n  var message = void 0;\n\n  switch (newState) {\n    case 'connected':\n      if (previousState === 'disconnected' || previousState === 'failed') {\n        message = 'ICE liveliness check succeeded. Connection with Twilio restored';\n\n        this._log.info(message);\n\n        this.onreconnected(message);\n      } else {\n        message = 'Media connection established.';\n\n        this._log.info(message);\n\n        this.onconnected(message);\n      }\n\n      this._stopIceGatheringTimeout();\n\n      this._hasIceGatheringFailures = false;\n      break;\n\n    case 'disconnected':\n      message = 'ICE liveliness check failed. May be having trouble connecting to Twilio';\n\n      this._log.info(message);\n\n      this.ondisconnected(message);\n      break;\n\n    case 'failed':\n      message = 'Connection with Twilio was interrupted.';\n\n      this._log.info(message);\n\n      this.onfailed(message);\n      break;\n  }\n};\n\nPeerConnection.prototype._setSinkIds = function (sinkIds) {\n  if (!this._isSinkSupported) {\n    return Promise.reject(new NotSupportedError('Audio output selection is not supported by this browser'));\n  }\n\n  this.sinkIds = new Set(sinkIds.forEach ? sinkIds : [sinkIds]);\n  return this.version ? this._updateAudioOutputs() : Promise.resolve();\n};\n/**\n * Start timeout for ICE Gathering\n */\n\n\nPeerConnection.prototype._startIceGatheringTimeout = function startIceGatheringTimeout() {\n  var _this3 = this;\n\n  this._stopIceGatheringTimeout();\n\n  this._iceGatheringTimeoutId = setTimeout(function () {\n    _this3._onIceGatheringFailure(ICE_GATHERING_FAIL_TIMEOUT);\n  }, ICE_GATHERING_TIMEOUT);\n};\n/**\n * Stop timeout for ICE Gathering\n */\n\n\nPeerConnection.prototype._stopIceGatheringTimeout = function stopIceGatheringTimeout() {\n  clearInterval(this._iceGatheringTimeoutId);\n};\n\nPeerConnection.prototype._updateAudioOutputs = function updateAudioOutputs() {\n  var addedOutputIds = Array.from(this.sinkIds).filter(function (id) {\n    return !this.outputs.has(id);\n  }, this);\n  var removedOutputIds = Array.from(this.outputs.keys()).filter(function (id) {\n    return !this.sinkIds.has(id);\n  }, this);\n  var self = this;\n  var createOutputPromises = addedOutputIds.map(this._createAudioOutput, this);\n  return Promise.all(createOutputPromises).then(function () {\n    return Promise.all(removedOutputIds.map(self._removeAudioOutput, self));\n  });\n};\n\nPeerConnection.prototype._createAudio = function createAudio(arr) {\n  return new Audio(arr);\n};\n\nPeerConnection.prototype._createAudioOutput = function createAudioOutput(id) {\n  var dest = this._audioContext.createMediaStreamDestination();\n\n  this._mediaStreamSource.connect(dest);\n\n  var audio = this._createAudio();\n\n  setAudioSource(audio, dest.stream);\n  var self = this;\n  return audio.setSinkId(id).then(function () {\n    return audio.play();\n  }).then(function () {\n    self.outputs.set(id, {\n      audio: audio,\n      dest: dest\n    });\n  });\n};\n\nPeerConnection.prototype._removeAudioOutputs = function removeAudioOutputs() {\n  if (this._masterAudio && typeof this._masterAudioDeviceId !== 'undefined') {\n    this._disableOutput(this, this._masterAudioDeviceId);\n\n    this.outputs.delete(this._masterAudioDeviceId);\n    this._masterAudioDeviceId = null; // Release the audio resources before deleting the audio\n\n    if (!this._masterAudio.paused) {\n      this._masterAudio.pause();\n    }\n\n    if (typeof this._masterAudio.srcObject !== 'undefined') {\n      this._masterAudio.srcObject = null;\n    } else {\n      this._masterAudio.src = '';\n    }\n\n    this._masterAudio = null;\n  }\n\n  return Array.from(this.outputs.keys()).map(this._removeAudioOutput, this);\n};\n\nPeerConnection.prototype._disableOutput = function disableOutput(pc, id) {\n  var output = pc.outputs.get(id);\n\n  if (!output) {\n    return;\n  }\n\n  if (output.audio) {\n    output.audio.pause();\n    output.audio.src = '';\n  }\n\n  if (output.dest) {\n    output.dest.disconnect();\n  }\n};\n/**\n * Disable a non-master output, and update the master output to assume its state. This\n *   is called when the device ID assigned to the master output has been removed from\n *   active devices. We can not simply remove the master audio output, so we must\n *   instead reassign it.\n * @private\n * @param {PeerConnection} pc\n * @param {string} masterId - The current device ID assigned to the master audio element.\n */\n\n\nPeerConnection.prototype._reassignMasterOutput = function reassignMasterOutput(pc, masterId) {\n  var masterOutput = pc.outputs.get(masterId);\n  pc.outputs.delete(masterId);\n  var self = this;\n  var idToReplace = Array.from(pc.outputs.keys())[0] || 'default';\n  return masterOutput.audio.setSinkId(idToReplace).then(function () {\n    self._disableOutput(pc, idToReplace);\n\n    pc.outputs.set(idToReplace, masterOutput);\n    pc._masterAudioDeviceId = idToReplace;\n  }).catch(function rollback() {\n    pc.outputs.set(masterId, masterOutput);\n\n    self._log.info('Could not reassign master output. Attempted to roll back.');\n  });\n};\n\nPeerConnection.prototype._removeAudioOutput = function removeAudioOutput(id) {\n  if (this._masterAudioDeviceId === id) {\n    return this._reassignMasterOutput(this, id);\n  }\n\n  this._disableOutput(this, id);\n\n  this.outputs.delete(id);\n  return Promise.resolve();\n};\n/**\n * Use an AudioContext to potentially split our audio output stream to multiple\n *   audio devices. This is only available to browsers with AudioContext and\n *   HTMLAudioElement.setSinkId() available. We save the source stream in\n *   _masterAudio, and use it for one of the active audio devices. We keep\n *   track of its ID because we must replace it if we lose its initial device.\n */\n\n\nPeerConnection.prototype._onAddTrack = function onAddTrack(pc, stream) {\n  var audio = pc._masterAudio = this._createAudio();\n\n  setAudioSource(audio, stream);\n  audio.play(); // Assign the initial master audio element to a random active output device\n\n  var deviceId = Array.from(pc.outputs.keys())[0] || 'default';\n  pc._masterAudioDeviceId = deviceId;\n  pc.outputs.set(deviceId, {\n    audio: audio\n  });\n  pc._mediaStreamSource = pc._audioContext.createMediaStreamSource(stream);\n  pc.pcStream = stream;\n\n  pc._updateAudioOutputs();\n};\n/**\n * Use a single audio element to play the audio output stream. This does not\n *   support multiple output devices, and is a fallback for when AudioContext\n *   and/or HTMLAudioElement.setSinkId() is not available to the client.\n */\n\n\nPeerConnection.prototype._fallbackOnAddTrack = function fallbackOnAddTrack(pc, stream) {\n  var audio = document && document.createElement('audio');\n  audio.autoplay = true;\n\n  if (!setAudioSource(audio, stream)) {\n    pc._log.info('Error attaching stream to element.');\n  }\n\n  pc.outputs.set('default', {\n    audio: audio\n  });\n};\n\nPeerConnection.prototype._setEncodingParameters = function (enableDscp) {\n  if (!enableDscp || !this._sender || typeof this._sender.getParameters !== 'function' || typeof this._sender.setParameters !== 'function') {\n    return;\n  }\n\n  var params = this._sender.getParameters();\n\n  if (!params.priority && !(params.encodings && params.encodings.length)) {\n    return;\n  } // This is how MDN's RTPSenderParameters defines priority\n\n\n  params.priority = 'high'; // And this is how it's currently implemented in Chrome M72+\n\n  if (params.encodings && params.encodings.length) {\n    params.encodings.forEach(function (encoding) {\n      encoding.priority = 'high';\n      encoding.networkPriority = 'high';\n    });\n  }\n\n  this._sender.setParameters(params);\n};\n\nPeerConnection.prototype._setupPeerConnection = function (rtcConstraints, rtcConfiguration) {\n  var _this4 = this;\n\n  var self = this;\n  var version = new (this.options.rtcpcFactory || RTCPC)();\n  version.create(rtcConstraints, rtcConfiguration);\n  addStream(version.pc, this.stream);\n  var eventName = 'ontrack' in version.pc ? 'ontrack' : 'onaddstream';\n\n  version.pc[eventName] = function (event) {\n    var stream = self._remoteStream = event.stream || event.streams[0];\n\n    if (typeof version.pc.getSenders === 'function') {\n      _this4._sender = version.pc.getSenders()[0];\n    }\n\n    if (self._isSinkSupported) {\n      self._onAddTrack(self, stream);\n    } else {\n      self._fallbackOnAddTrack(self, stream);\n    }\n\n    self._startPollingVolume();\n  };\n\n  return version;\n};\n\nPeerConnection.prototype._maybeSetIceAggressiveNomination = function (sdp) {\n  return this.options.forceAggressiveIceNomination ? setIceAggressiveNomination(sdp) : sdp;\n};\n\nPeerConnection.prototype._setupChannel = function () {\n  var _this5 = this;\n\n  var pc = this.version.pc; // Chrome 25 supports onopen\n\n  this.version.pc.onopen = function () {\n    _this5.status = 'open';\n\n    _this5.onopen();\n  }; // Chrome 26 doesn't support onopen so must detect state change\n\n\n  this.version.pc.onstatechange = function () {\n    if (_this5.version.pc && _this5.version.pc.readyState === 'stable') {\n      _this5.status = 'open';\n\n      _this5.onopen();\n    }\n  }; // Chrome 27 changed onstatechange to onsignalingstatechange\n\n\n  this.version.pc.onsignalingstatechange = function () {\n    var state = pc.signalingState;\n\n    _this5._log.info('signalingState is \"' + state + '\"');\n\n    if (_this5.version.pc && _this5.version.pc.signalingState === 'stable') {\n      _this5.status = 'open';\n\n      _this5.onopen();\n    }\n\n    _this5.onsignalingstatechange(pc.signalingState);\n  }; // Chrome 72+\n\n\n  pc.onconnectionstatechange = function () {\n    _this5._log.info('pc.connectionState is \"' + pc.connectionState + '\"');\n\n    _this5.onpcconnectionstatechange(pc.connectionState);\n\n    _this5._onMediaConnectionStateChange(pc.connectionState);\n  };\n\n  pc.onicecandidate = function (event) {\n    var candidate = event.candidate;\n\n    if (candidate) {\n      _this5._hasIceCandidates = true;\n\n      _this5.onicecandidate(candidate);\n\n      _this5._setupRTCIceTransportListener();\n    }\n\n    _this5._log.info('ICE Candidate: ' + JSON.stringify(candidate));\n  };\n\n  pc.onicegatheringstatechange = function () {\n    var state = pc.iceGatheringState;\n\n    if (state === 'gathering') {\n      _this5._startIceGatheringTimeout();\n    } else if (state === 'complete') {\n      _this5._stopIceGatheringTimeout(); // Fail if no candidates found\n\n\n      if (!_this5._hasIceCandidates) {\n        _this5._onIceGatheringFailure(ICE_GATHERING_FAIL_NONE);\n      } // There was a failure mid-gathering phase. We want to start our timer and issue\n      // an ice restart if we don't get connected after our timeout\n\n\n      if (_this5._hasIceCandidates && _this5._hasIceGatheringFailures) {\n        _this5._startIceGatheringTimeout();\n      }\n    }\n\n    _this5._log.info('pc.iceGatheringState is \"' + pc.iceGatheringState + '\"');\n\n    _this5.onicegatheringstatechange(state);\n  };\n\n  pc.oniceconnectionstatechange = function () {\n    _this5._log.info('pc.iceConnectionState is \"' + pc.iceConnectionState + '\"');\n\n    _this5.oniceconnectionstatechange(pc.iceConnectionState);\n\n    _this5._onMediaConnectionStateChange(pc.iceConnectionState);\n  };\n};\n\nPeerConnection.prototype._initializeMediaStream = function (rtcConstraints, rtcConfiguration) {\n  // if mediastream already open then do nothing\n  if (this.status === 'open') {\n    return false;\n  }\n\n  if (this.pstream.status === 'disconnected') {\n    this.onerror({\n      info: {\n        code: 31000,\n        message: 'Cannot establish connection. Client is disconnected',\n        twilioError: new SignalingErrors.ConnectionDisconnected()\n      }\n    });\n    this.close();\n    return false;\n  }\n\n  this.version = this._setupPeerConnection(rtcConstraints, rtcConfiguration);\n\n  this._setupChannel();\n\n  return true;\n};\n/**\n * Remove reconnection-related listeners\n * @private\n */\n\n\nPeerConnection.prototype._removeReconnectionListeners = function () {\n  if (this.pstream) {\n    this.pstream.removeListener('answer', this._onAnswerOrRinging);\n    this.pstream.removeListener('hangup', this._onHangup);\n  }\n};\n/**\n * Setup a listener for RTCDtlsTransport to capture state changes events\n * @private\n */\n\n\nPeerConnection.prototype._setupRTCDtlsTransportListener = function () {\n  var _this6 = this;\n\n  var dtlsTransport = this.getRTCDtlsTransport();\n\n  if (!dtlsTransport || dtlsTransport.onstatechange) {\n    return;\n  }\n\n  var handler = function handler() {\n    _this6._log.info('dtlsTransportState is \"' + dtlsTransport.state + '\"');\n\n    _this6.ondtlstransportstatechange(dtlsTransport.state);\n  }; // Publish initial state\n\n\n  handler();\n  dtlsTransport.onstatechange = handler;\n};\n/**\n * Setup a listener for RTCIceTransport to capture selected candidate pair changes\n * @private\n */\n\n\nPeerConnection.prototype._setupRTCIceTransportListener = function () {\n  var _this7 = this;\n\n  var iceTransport = this._getRTCIceTransport();\n\n  if (!iceTransport || iceTransport.onselectedcandidatepairchange) {\n    return;\n  }\n\n  iceTransport.onselectedcandidatepairchange = function () {\n    return _this7.onselectedcandidatepairchange(iceTransport.getSelectedCandidatePair());\n  };\n};\n/**\n * Restarts ICE for the current connection\n * ICE Restart failures are ignored. Retries are managed in Connection\n * @private\n */\n\n\nPeerConnection.prototype.iceRestart = function () {\n  var _this8 = this;\n\n  if (!this.options.enableIceRestart) {\n    return;\n  }\n\n  this._log.info('Attempting to restart ICE...');\n\n  this._hasIceCandidates = false;\n  this.version.createOffer(this.options.maxAverageBitrate, this.codecPreferences, {\n    iceRestart: true\n  }).then(function () {\n    _this8._removeReconnectionListeners();\n\n    _this8._onAnswerOrRinging = function (payload) {\n      _this8._removeReconnectionListeners();\n\n      if (!payload.sdp || _this8.version.pc.signalingState !== 'have-local-offer') {\n        var message = 'Invalid state or param during ICE Restart:' + ('hasSdp:' + !!payload.sdp + ', signalingState:' + _this8.version.pc.signalingState);\n\n        _this8._log.info(message);\n\n        return;\n      }\n\n      var sdp = _this8._maybeSetIceAggressiveNomination(payload.sdp);\n\n      _this8._answerSdp = sdp;\n\n      if (_this8.status !== 'closed') {\n        _this8.version.processAnswer(_this8.codecPreferences, sdp, null, function (err) {\n          var message = err && err.message ? err.message : err;\n\n          _this8._log.info('Failed to process answer during ICE Restart. Error: ' + message);\n        });\n      }\n    };\n\n    _this8._onHangup = function () {\n      _this8._log.info('Received hangup during ICE Restart');\n\n      _this8._removeReconnectionListeners();\n    };\n\n    _this8.pstream.on('answer', _this8._onAnswerOrRinging);\n\n    _this8.pstream.on('hangup', _this8._onHangup);\n\n    _this8.pstream.reinvite(_this8.version.getSDP(), _this8.callSid);\n  }).catch(function (err) {\n    var message = err && err.message ? err.message : err;\n\n    _this8._log.info('Failed to createOffer during ICE Restart. Error: ' + message); // CreateOffer failures doesn't transition ice state to failed\n    // We need trigger it so it can be picked up by retries\n\n\n    _this8.onfailed(message);\n  });\n};\n\nPeerConnection.prototype.makeOutgoingCall = function (token, params, callsid, rtcConstraints, rtcConfiguration, onMediaStarted) {\n  var _this9 = this;\n\n  if (!this._initializeMediaStream(rtcConstraints, rtcConfiguration)) {\n    return;\n  }\n\n  var self = this;\n  this.callSid = callsid;\n\n  function onAnswerSuccess() {\n    if (self.options) {\n      self._setEncodingParameters(self.options.dscp);\n    }\n\n    onMediaStarted(self.version.pc);\n  }\n\n  function onAnswerError(err) {\n    var errMsg = err.message || err;\n    self.onerror({\n      info: {\n        code: 31000,\n        message: 'Error processing answer: ' + errMsg,\n        twilioError: new MediaErrors.ClientRemoteDescFailed()\n      }\n    });\n  }\n\n  this._onAnswerOrRinging = function (payload) {\n    if (!payload.sdp) {\n      return;\n    }\n\n    var sdp = _this9._maybeSetIceAggressiveNomination(payload.sdp);\n\n    self._answerSdp = sdp;\n\n    if (self.status !== 'closed') {\n      self.version.processAnswer(_this9.codecPreferences, sdp, onAnswerSuccess, onAnswerError);\n    }\n\n    self.pstream.removeListener('answer', self._onAnswerOrRinging);\n    self.pstream.removeListener('ringing', self._onAnswerOrRinging);\n  };\n\n  this.pstream.on('answer', this._onAnswerOrRinging);\n  this.pstream.on('ringing', this._onAnswerOrRinging);\n\n  function onOfferSuccess() {\n    if (self.status !== 'closed') {\n      self.pstream.invite(self.version.getSDP(), self.callSid, self.options.preflight, params);\n\n      self._setupRTCDtlsTransportListener();\n    }\n  }\n\n  function onOfferError(err) {\n    var errMsg = err.message || err;\n    self.onerror({\n      info: {\n        code: 31000,\n        message: 'Error creating the offer: ' + errMsg,\n        twilioError: new MediaErrors.ClientLocalDescFailed()\n      }\n    });\n  }\n\n  this.version.createOffer(this.options.maxAverageBitrate, this.codecPreferences, {\n    audio: true\n  }, onOfferSuccess, onOfferError);\n};\n\nPeerConnection.prototype.answerIncomingCall = function (callSid, sdp, rtcConstraints, rtcConfiguration, onMediaStarted) {\n  if (!this._initializeMediaStream(rtcConstraints, rtcConfiguration)) {\n    return;\n  }\n\n  sdp = this._maybeSetIceAggressiveNomination(sdp);\n  this._answerSdp = sdp.replace(/^a=setup:actpass$/gm, 'a=setup:passive');\n  this.callSid = callSid;\n  var self = this;\n\n  function onAnswerSuccess() {\n    if (self.status !== 'closed') {\n      self.pstream.answer(self.version.getSDP(), callSid);\n\n      if (self.options) {\n        self._setEncodingParameters(self.options.dscp);\n      }\n\n      onMediaStarted(self.version.pc);\n\n      self._setupRTCDtlsTransportListener();\n    }\n  }\n\n  function onAnswerError(err) {\n    var errMsg = err.message || err;\n    self.onerror({\n      info: {\n        code: 31000,\n        message: 'Error creating the answer: ' + errMsg,\n        twilioError: new MediaErrors.ClientRemoteDescFailed()\n      }\n    });\n  }\n\n  this.version.processSDP(this.options.maxAverageBitrate, this.codecPreferences, sdp, {\n    audio: true\n  }, onAnswerSuccess, onAnswerError);\n};\n\nPeerConnection.prototype.close = function () {\n  if (this.version && this.version.pc) {\n    if (this.version.pc.signalingState !== 'closed') {\n      this.version.pc.close();\n    }\n\n    this.version.pc = null;\n  }\n\n  if (this.stream) {\n    this.mute(false);\n\n    this._stopStream(this.stream);\n  }\n\n  this.stream = null;\n\n  this._removeReconnectionListeners();\n\n  this._stopIceGatheringTimeout();\n\n  Promise.all(this._removeAudioOutputs()).catch(function () {// We don't need to alert about failures here.\n  });\n\n  if (this._mediaStreamSource) {\n    this._mediaStreamSource.disconnect();\n  }\n\n  if (this._inputAnalyser) {\n    this._inputAnalyser.disconnect();\n  }\n\n  if (this._outputAnalyser) {\n    this._outputAnalyser.disconnect();\n  }\n\n  if (this._inputAnalyser2) {\n    this._inputAnalyser2.disconnect();\n  }\n\n  if (this._outputAnalyser2) {\n    this._outputAnalyser2.disconnect();\n  }\n\n  this.status = 'closed';\n  this.onclose();\n};\n\nPeerConnection.prototype.reject = function (callSid) {\n  this.callSid = callSid;\n};\n\nPeerConnection.prototype.ignore = function (callSid) {\n  this.callSid = callSid;\n};\n/**\n * Mute or unmute input audio. If the stream is not yet present, the setting\n *   is saved and applied to future streams/tracks.\n * @params {boolean} shouldMute - Whether the input audio should\n *   be muted or unmuted.\n */\n\n\nPeerConnection.prototype.mute = function (shouldMute) {\n  this.isMuted = shouldMute;\n\n  if (!this.stream) {\n    return;\n  }\n\n  if (this._sender && this._sender.track) {\n    this._sender.track.enabled = !shouldMute;\n  } else {\n    var audioTracks = typeof this.stream.getAudioTracks === 'function' ? this.stream.getAudioTracks() : this.stream.audioTracks;\n    audioTracks.forEach(function (track) {\n      track.enabled = !shouldMute;\n    });\n  }\n};\n/**\n * Get or create an RTCDTMFSender for the first local audio MediaStreamTrack\n * we can get from the RTCPeerConnection. Return null if unsupported.\n * @instance\n * @returns ?RTCDTMFSender\n */\n\n\nPeerConnection.prototype.getOrCreateDTMFSender = function getOrCreateDTMFSender() {\n  if (this._dtmfSender || this._dtmfSenderUnsupported) {\n    return this._dtmfSender || null;\n  }\n\n  var self = this;\n  var pc = this.version.pc;\n\n  if (!pc) {\n    this._log.info('No RTCPeerConnection available to call createDTMFSender on');\n\n    return null;\n  }\n\n  if (typeof pc.getSenders === 'function' && (typeof RTCDTMFSender === 'function' || typeof RTCDtmfSender === 'function')) {\n    var chosenSender = pc.getSenders().find(function (sender) {\n      return sender.dtmf;\n    });\n\n    if (chosenSender) {\n      this._log.info('Using RTCRtpSender#dtmf');\n\n      this._dtmfSender = chosenSender.dtmf;\n      return this._dtmfSender;\n    }\n  }\n\n  if (typeof pc.createDTMFSender === 'function' && typeof pc.getLocalStreams === 'function') {\n    var track = pc.getLocalStreams().map(function (stream) {\n      var tracks = self._getAudioTracks(stream);\n\n      return tracks && tracks[0];\n    })[0];\n\n    if (!track) {\n      this._log.info('No local audio MediaStreamTrack available on the RTCPeerConnection to pass to createDTMFSender');\n\n      return null;\n    }\n\n    this._log.info('Creating RTCDTMFSender');\n\n    this._dtmfSender = pc.createDTMFSender(track);\n    return this._dtmfSender;\n  }\n\n  this._log.info('RTCPeerConnection does not support RTCDTMFSender');\n\n  this._dtmfSenderUnsupported = true;\n  return null;\n};\n/**\n * Get the RTCDtlTransport object from the PeerConnection\n * @returns RTCDtlTransport\n */\n\n\nPeerConnection.prototype.getRTCDtlsTransport = function getRTCDtlsTransport() {\n  var sender = this.version && this.version.pc && typeof this.version.pc.getSenders === 'function' && this.version.pc.getSenders()[0];\n  return sender && sender.transport || null;\n};\n\nPeerConnection.prototype._canStopMediaStreamTrack = function () {\n  return typeof MediaStreamTrack.prototype.stop === 'function';\n};\n\nPeerConnection.prototype._getAudioTracks = function (stream) {\n  return typeof stream.getAudioTracks === 'function' ? stream.getAudioTracks() : stream.audioTracks;\n};\n/**\n * Get the RTCIceTransport object from the PeerConnection\n * @returns RTCIceTransport\n */\n\n\nPeerConnection.prototype._getRTCIceTransport = function _getRTCIceTransport() {\n  var dtlsTransport = this.getRTCDtlsTransport();\n  return dtlsTransport && dtlsTransport.iceTransport || null;\n}; // Is PeerConnection.protocol used outside of our SDK? We should remove this if not.\n\n\nPeerConnection.protocol = function () {\n  return RTCPC.test() ? new RTCPC() : null;\n}();\n\nfunction addStream(pc, stream) {\n  if (typeof pc.addTrack === 'function') {\n    stream.getAudioTracks().forEach(function (track) {\n      // The second parameters, stream, should not be necessary per the latest editor's\n      //   draft, but FF requires it. https://bugzilla.mozilla.org/show_bug.cgi?id=1231414\n      pc.addTrack(track, stream);\n    });\n  } else {\n    pc.addStream(stream);\n  }\n}\n\nfunction cloneStream(oldStream) {\n  var newStream = typeof MediaStream !== 'undefined' ? new MediaStream() // eslint-disable-next-line\n  : new webkitMediaStream();\n  oldStream.getAudioTracks().forEach(newStream.addTrack, newStream);\n  return newStream;\n}\n\nfunction removeStream(pc, stream) {\n  if (typeof pc.removeTrack === 'function') {\n    pc.getSenders().forEach(function (sender) {\n      pc.removeTrack(sender);\n    });\n  } else {\n    pc.removeStream(stream);\n  }\n}\n/**\n * Set the source of an HTMLAudioElement to the specified MediaStream\n * @param {HTMLAudioElement} audio\n * @param {MediaStream} stream\n * @returns {boolean} Whether the audio source was set successfully\n */\n\n\nfunction setAudioSource(audio, stream) {\n  if (typeof audio.srcObject !== 'undefined') {\n    audio.srcObject = stream;\n  } else if (typeof audio.mozSrcObject !== 'undefined') {\n    audio.mozSrcObject = stream;\n  } else if (typeof audio.src !== 'undefined') {\n    var _window = audio.options.window || window;\n\n    audio.src = (_window.URL || _window.webkitURL).createObjectURL(stream);\n  } else {\n    return false;\n  }\n\n  return true;\n}\n\nPeerConnection.enabled = RTCPC.test();\nmodule.exports = PeerConnection;","map":{"version":3,"sources":["/root/twilio-phone-client/node_modules/twilio-client/es5/twilio/rtc/peerconnection.js"],"names":["_require","require","InvalidArgumentError","MediaErrors","NotSupportedError","SignalingErrors","Log","default","util","RTCPC","_require2","setIceAggressiveNomination","ICE_GATHERING_TIMEOUT","ICE_GATHERING_FAIL_NONE","ICE_GATHERING_FAIL_TIMEOUT","INITIAL_ICE_CONNECTION_STATE","VOLUME_INTERVAL_MS","PeerConnection","audioHelper","pstream","getUserMedia","options","noop","onopen","onerror","onclose","ondisconnected","onfailed","onconnected","onreconnected","onsignalingstatechange","ondtlstransportstatechange","onicegatheringfailure","onicegatheringstatechange","oniceconnectionstatechange","onpcconnectionstatechange","onicecandidate","onselectedcandidatepairchange","onvolume","version","stream","sinkIds","Set","outputs","Map","status","callSid","isMuted","AudioContext","window","webkitAudioContext","_isSinkSupported","HTMLAudioElement","prototype","setSinkId","_audioContext","_hasIceCandidates","_hasIceGatheringFailures","_iceGatheringTimeoutId","_masterAudio","_masterAudioDeviceId","_mediaStreamSource","_dtmfSender","_dtmfSenderUnsupported","_callEvents","_nextTimeToPublish","Date","now","_onAnswerOrRinging","_onHangup","_remoteStream","_shouldManageStream","_iceState","_isUnifiedPlan","isUnifiedPlan","navigator","codecPreferences","_log","getInstance","uri","_uri","openWithConstraints","constraints","audio","then","_setInputTracksFromStream","bind","setInputTracksFromStream","self","_createAnalyser","audioContext","Object","assign","fftSize","smoothingTimeConstant","analyser","createAnalyser","field","_setVolumeHandler","handler","_startPollingVolume","inputAnalyser","_inputAnalyser","inputBufferLength","frequencyBinCount","inputDataArray","Uint8Array","_inputAnalyser2","minDecibels","maxDecibels","outputAnalyser","_outputAnalyser","outputBufferLength","outputDataArray","_outputAnalyser2","_updateInputStreamSource","_updateOutputStreamSource","setTimeout","emitVolume","disconnect","getByteFrequencyData","inputVolume","average","inputVolume2","outputVolume","outputVolume2","_stopStream","MediaStreamTrack","stop","audioTracks","getAudioTracks","forEach","track","_inputStreamSource","createMediaStreamSource","connect","_outputStreamSource","shouldClone","newStream","_setInputTracksForUnifiedPlan","_setInputTracksForPlanB","_this","Promise","reject","length","localStream","cloneStream","removeStream","pc","removeTrack","addTrack","addStream","mute","resolve","createOffer","maxAverageBitrate","processAnswer","_answerSdp","_this2","getStreamPromise","_sender","getSenders","replaceTrack","_onInputDevicesChanged","activeInputWasLost","every","readyState","_onIceGatheringFailure","type","_onMediaConnectionStateChange","newState","previousState","message","info","_stopIceGatheringTimeout","_setSinkIds","_updateAudioOutputs","_startIceGatheringTimeout","startIceGatheringTimeout","_this3","stopIceGatheringTimeout","clearInterval","updateAudioOutputs","addedOutputIds","Array","from","filter","id","has","removedOutputIds","keys","createOutputPromises","map","_createAudioOutput","all","_removeAudioOutput","_createAudio","createAudio","arr","Audio","createAudioOutput","dest","createMediaStreamDestination","setAudioSource","play","set","_removeAudioOutputs","removeAudioOutputs","_disableOutput","delete","paused","pause","srcObject","src","disableOutput","output","get","_reassignMasterOutput","reassignMasterOutput","masterId","masterOutput","idToReplace","catch","rollback","removeAudioOutput","_onAddTrack","onAddTrack","deviceId","pcStream","_fallbackOnAddTrack","fallbackOnAddTrack","document","createElement","autoplay","_setEncodingParameters","enableDscp","getParameters","setParameters","params","priority","encodings","encoding","networkPriority","_setupPeerConnection","rtcConstraints","rtcConfiguration","_this4","rtcpcFactory","create","eventName","event","streams","_maybeSetIceAggressiveNomination","sdp","forceAggressiveIceNomination","_setupChannel","_this5","onstatechange","state","signalingState","onconnectionstatechange","connectionState","candidate","_setupRTCIceTransportListener","JSON","stringify","iceGatheringState","iceConnectionState","_initializeMediaStream","code","twilioError","ConnectionDisconnected","close","_removeReconnectionListeners","removeListener","_setupRTCDtlsTransportListener","_this6","dtlsTransport","getRTCDtlsTransport","_this7","iceTransport","_getRTCIceTransport","getSelectedCandidatePair","iceRestart","_this8","enableIceRestart","payload","err","on","reinvite","getSDP","makeOutgoingCall","token","callsid","onMediaStarted","_this9","onAnswerSuccess","dscp","onAnswerError","errMsg","ClientRemoteDescFailed","onOfferSuccess","invite","preflight","onOfferError","ClientLocalDescFailed","answerIncomingCall","replace","answer","processSDP","ignore","shouldMute","enabled","getOrCreateDTMFSender","RTCDTMFSender","RTCDtmfSender","chosenSender","find","sender","dtmf","createDTMFSender","getLocalStreams","tracks","_getAudioTracks","transport","_canStopMediaStreamTrack","protocol","test","oldStream","MediaStream","webkitMediaStream","mozSrcObject","_window","URL","webkitURL","createObjectURL","module","exports"],"mappings":"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","sourcesContent":["'use strict';\n\nvar _require = require('../errors'),\n    InvalidArgumentError = _require.InvalidArgumentError,\n    MediaErrors = _require.MediaErrors,\n    NotSupportedError = _require.NotSupportedError,\n    SignalingErrors = _require.SignalingErrors;\n\nvar Log = require('../log').default;\nvar util = require('../util');\nvar RTCPC = require('./rtcpc');\n\nvar _require2 = require('./sdp'),\n    setIceAggressiveNomination = _require2.setIceAggressiveNomination;\n\nvar ICE_GATHERING_TIMEOUT = 15000;\nvar ICE_GATHERING_FAIL_NONE = 'none';\nvar ICE_GATHERING_FAIL_TIMEOUT = 'timeout';\nvar INITIAL_ICE_CONNECTION_STATE = 'new';\nvar VOLUME_INTERVAL_MS = 50;\n\n/**\n * @typedef {Object} PeerConnection\n * @param audioHelper\n * @param pstream\n * @param options\n * @return {PeerConnection}\n * @constructor\n */\nfunction PeerConnection(audioHelper, pstream, getUserMedia, options) {\n  if (!audioHelper || !pstream || !getUserMedia) {\n    throw new InvalidArgumentError('Audiohelper, pstream and getUserMedia are required arguments');\n  }\n\n  if (!(this instanceof PeerConnection)) {\n    return new PeerConnection(audioHelper, pstream, getUserMedia, options);\n  }\n\n  function noop() {}\n  this.onopen = noop;\n  this.onerror = noop;\n  this.onclose = noop;\n  this.ondisconnected = noop;\n  this.onfailed = noop;\n  this.onconnected = noop;\n  this.onreconnected = noop;\n  this.onsignalingstatechange = noop;\n  this.ondtlstransportstatechange = noop;\n  this.onicegatheringfailure = noop;\n  this.onicegatheringstatechange = noop;\n  this.oniceconnectionstatechange = noop;\n  this.onpcconnectionstatechange = noop;\n  this.onicecandidate = noop;\n  this.onselectedcandidatepairchange = noop;\n  this.onvolume = noop;\n  this.version = null;\n  this.pstream = pstream;\n  this.stream = null;\n  this.sinkIds = new Set(['default']);\n  this.outputs = new Map();\n  this.status = 'connecting';\n  this.callSid = null;\n  this.isMuted = false;\n  this.getUserMedia = getUserMedia;\n\n  var AudioContext = typeof window !== 'undefined' && (window.AudioContext || window.webkitAudioContext);\n  this._isSinkSupported = !!AudioContext && typeof HTMLAudioElement !== 'undefined' && HTMLAudioElement.prototype.setSinkId;\n  // NOTE(mmalavalli): Since each Connection creates its own AudioContext,\n  // after 6 instances an exception is thrown. Refer https://www.w3.org/2011/audio/track/issues/3.\n  // In order to get around it, we are re-using the Device's AudioContext.\n  this._audioContext = AudioContext && audioHelper._audioContext;\n  this._hasIceCandidates = false;\n  this._hasIceGatheringFailures = false;\n  this._iceGatheringTimeoutId = null;\n  this._masterAudio = null;\n  this._masterAudioDeviceId = null;\n  this._mediaStreamSource = null;\n  this._dtmfSender = null;\n  this._dtmfSenderUnsupported = false;\n  this._callEvents = [];\n  this._nextTimeToPublish = Date.now();\n  this._onAnswerOrRinging = noop;\n  this._onHangup = noop;\n  this._remoteStream = null;\n  this._shouldManageStream = true;\n  this._iceState = INITIAL_ICE_CONNECTION_STATE;\n  this._isUnifiedPlan = options.isUnifiedPlan;\n\n  this.options = options = options || {};\n  this.navigator = options.navigator || (typeof navigator !== 'undefined' ? navigator : null);\n  this.util = options.util || util;\n  this.codecPreferences = options.codecPreferences;\n\n  this._log = Log.getInstance();\n\n  return this;\n}\n\nPeerConnection.prototype.uri = function () {\n  return this._uri;\n};\n\n/**\n * Open the underlying RTCPeerConnection with a MediaStream obtained by\n *   passed constraints. The resulting MediaStream is created internally\n *   and will therefore be managed and destroyed internally.\n * @param {MediaStreamConstraints} constraints\n */\nPeerConnection.prototype.openWithConstraints = function (constraints) {\n  return this.getUserMedia({ audio: constraints }).then(this._setInputTracksFromStream.bind(this, false));\n};\n\n/**\n * Replace the existing input audio tracks with the audio tracks from the\n *   passed input audio stream. We re-use the existing stream because\n *   the AnalyzerNode is bound to the stream.\n * @param {MediaStream} stream\n */\nPeerConnection.prototype.setInputTracksFromStream = function (stream) {\n  var self = this;\n  return this._setInputTracksFromStream(true, stream).then(function () {\n    self._shouldManageStream = false;\n  });\n};\n\nPeerConnection.prototype._createAnalyser = function (audioContext, options) {\n  options = Object.assign({\n    fftSize: 32,\n    smoothingTimeConstant: 0.3\n  }, options);\n\n  var analyser = audioContext.createAnalyser();\n  for (var field in options) {\n    analyser[field] = options[field];\n  }\n\n  return analyser;\n};\n\nPeerConnection.prototype._setVolumeHandler = function (handler) {\n  this.onvolume = handler;\n};\nPeerConnection.prototype._startPollingVolume = function () {\n  if (!this._audioContext || !this.stream || !this._remoteStream) {\n    return;\n  }\n\n  var audioContext = this._audioContext;\n\n  var inputAnalyser = this._inputAnalyser = this._createAnalyser(audioContext);\n  var inputBufferLength = inputAnalyser.frequencyBinCount;\n  var inputDataArray = new Uint8Array(inputBufferLength);\n  this._inputAnalyser2 = this._createAnalyser(audioContext, {\n    minDecibels: -127,\n    maxDecibels: 0,\n    smoothingTimeConstant: 0\n  });\n\n  var outputAnalyser = this._outputAnalyser = this._createAnalyser(audioContext);\n  var outputBufferLength = outputAnalyser.frequencyBinCount;\n  var outputDataArray = new Uint8Array(outputBufferLength);\n  this._outputAnalyser2 = this._createAnalyser(audioContext, {\n    minDecibels: -127,\n    maxDecibels: 0,\n    smoothingTimeConstant: 0\n  });\n\n  this._updateInputStreamSource(this.stream);\n  this._updateOutputStreamSource(this._remoteStream);\n\n  var self = this;\n  setTimeout(function emitVolume() {\n    if (!self._audioContext) {\n      return;\n    } else if (self.status === 'closed') {\n      self._inputAnalyser.disconnect();\n      self._outputAnalyser.disconnect();\n      self._inputAnalyser2.disconnect();\n      self._outputAnalyser2.disconnect();\n      return;\n    }\n\n    self._inputAnalyser.getByteFrequencyData(inputDataArray);\n    var inputVolume = self.util.average(inputDataArray);\n\n    self._inputAnalyser2.getByteFrequencyData(inputDataArray);\n    var inputVolume2 = self.util.average(inputDataArray);\n\n    self._outputAnalyser.getByteFrequencyData(outputDataArray);\n    var outputVolume = self.util.average(outputDataArray);\n\n    self._outputAnalyser2.getByteFrequencyData(outputDataArray);\n    var outputVolume2 = self.util.average(outputDataArray);\n    self.onvolume(inputVolume / 255, outputVolume / 255, inputVolume2, outputVolume2);\n\n    setTimeout(emitVolume, VOLUME_INTERVAL_MS);\n  }, VOLUME_INTERVAL_MS);\n};\n\nPeerConnection.prototype._stopStream = function _stopStream(stream) {\n  // We shouldn't stop the tracks if they were not created inside\n  //   this PeerConnection.\n  if (!this._shouldManageStream) {\n    return;\n  }\n\n  if (typeof MediaStreamTrack.prototype.stop === 'function') {\n    var audioTracks = typeof stream.getAudioTracks === 'function' ? stream.getAudioTracks() : stream.audioTracks;\n    audioTracks.forEach(function (track) {\n      track.stop();\n    });\n  }\n  // NOTE(mroberts): This is just a fallback to any ancient browsers that may\n  // not implement MediaStreamTrack.stop.\n  else {\n      stream.stop();\n    }\n};\n\n/**\n * Update the stream source with the new input audio stream.\n * @param {MediaStream} stream\n * @private\n */\nPeerConnection.prototype._updateInputStreamSource = function (stream) {\n  if (this._inputStreamSource) {\n    this._inputStreamSource.disconnect();\n  }\n\n  this._inputStreamSource = this._audioContext.createMediaStreamSource(stream);\n  this._inputStreamSource.connect(this._inputAnalyser);\n  this._inputStreamSource.connect(this._inputAnalyser2);\n};\n\n/**\n * Update the stream source with the new ouput audio stream.\n * @param {MediaStream} stream\n * @private\n */\nPeerConnection.prototype._updateOutputStreamSource = function (stream) {\n  if (this._outputStreamSource) {\n    this._outputStreamSource.disconnect();\n  }\n\n  this._outputStreamSource = this._audioContext.createMediaStreamSource(stream);\n  this._outputStreamSource.connect(this._outputAnalyser);\n  this._outputStreamSource.connect(this._outputAnalyser2);\n};\n\n/**\n * Replace the tracks of the current stream with new tracks. We do this rather than replacing the\n *   whole stream because AnalyzerNodes are bound to a stream.\n * @param {Boolean} shouldClone - Whether the stream should be cloned if it is the first\n *   stream, or set directly. As a rule of thumb, streams that are passed in externally may have\n *   their lifecycle managed externally, and should be cloned so that we do not tear it or its tracks\n *   down when the call ends. Streams that we create internally (inside PeerConnection) should be set\n *   directly so that when the call ends it is disposed of.\n * @param {MediaStream} newStream - The new stream to copy the tracks over from.\n * @private\n */\nPeerConnection.prototype._setInputTracksFromStream = function (shouldClone, newStream) {\n  return this._isUnifiedPlan ? this._setInputTracksForUnifiedPlan(shouldClone, newStream) : this._setInputTracksForPlanB(shouldClone, newStream);\n};\n\n/**\n * Replace the tracks of the current stream with new tracks using the 'plan-b' method.\n * @param {Boolean} shouldClone - Whether the stream should be cloned if it is the first\n *   stream, or set directly. As a rule of thumb, streams that are passed in externally may have\n *   their lifecycle managed externally, and should be cloned so that we do not tear it or its tracks\n *   down when the call ends. Streams that we create internally (inside PeerConnection) should be set\n *   directly so that when the call ends it is disposed of.\n * @param {MediaStream} newStream - The new stream to copy the tracks over from.\n * @private\n */\nPeerConnection.prototype._setInputTracksForPlanB = function (shouldClone, newStream) {\n  var _this = this;\n\n  if (!newStream) {\n    return Promise.reject(new InvalidArgumentError('Can not set input stream to null while in a call'));\n  }\n\n  if (!newStream.getAudioTracks().length) {\n    return Promise.reject(new InvalidArgumentError('Supplied input stream has no audio tracks'));\n  }\n\n  var localStream = this.stream;\n\n  if (!localStream) {\n    // We can't use MediaStream.clone() here because it stopped copying over tracks\n    //   as of Chrome 61. https://bugs.chromium.org/p/chromium/issues/detail?id=770908\n    this.stream = shouldClone ? cloneStream(newStream) : newStream;\n  } else {\n    this._stopStream(localStream);\n\n    removeStream(this.version.pc, localStream);\n    localStream.getAudioTracks().forEach(localStream.removeTrack, localStream);\n    newStream.getAudioTracks().forEach(localStream.addTrack, localStream);\n    addStream(this.version.pc, newStream);\n\n    this._updateInputStreamSource(this.stream);\n  }\n\n  // Apply mute settings to new input track\n  this.mute(this.isMuted);\n\n  if (!this.version) {\n    return Promise.resolve(this.stream);\n  }\n\n  return new Promise(function (resolve, reject) {\n    _this.version.createOffer(_this.options.maxAverageBitrate, _this.codecPreferences, { audio: true }, function () {\n      _this.version.processAnswer(_this.codecPreferences, _this._answerSdp, function () {\n        resolve(_this.stream);\n      }, reject);\n    }, reject);\n  });\n};\n\n/**\n * Replace the tracks of the current stream with new tracks using the 'unified-plan' method.\n * @param {Boolean} shouldClone - Whether the stream should be cloned if it is the first\n *   stream, or set directly. As a rule of thumb, streams that are passed in externally may have\n *   their lifecycle managed externally, and should be cloned so that we do not tear it or its tracks\n *   down when the call ends. Streams that we create internally (inside PeerConnection) should be set\n *   directly so that when the call ends it is disposed of.\n * @param {MediaStream} newStream - The new stream to copy the tracks over from.\n * @private\n */\nPeerConnection.prototype._setInputTracksForUnifiedPlan = function (shouldClone, newStream) {\n  var _this2 = this;\n\n  if (!newStream) {\n    return Promise.reject(new InvalidArgumentError('Can not set input stream to null while in a call'));\n  }\n\n  if (!newStream.getAudioTracks().length) {\n    return Promise.reject(new InvalidArgumentError('Supplied input stream has no audio tracks'));\n  }\n\n  var localStream = this.stream;\n  var getStreamPromise = function getStreamPromise() {\n    // Apply mute settings to new input track\n    _this2.mute(_this2.isMuted);\n    return Promise.resolve(_this2.stream);\n  };\n\n  if (!localStream) {\n    // We can't use MediaStream.clone() here because it stopped copying over tracks\n    //   as of Chrome 61. https://bugs.chromium.org/p/chromium/issues/detail?id=770908\n    this.stream = shouldClone ? cloneStream(newStream) : newStream;\n  } else {\n    // If the call was started with gUM, and we are now replacing that track with an\n    // external stream's tracks, we should stop the old managed track.\n    if (this._shouldManageStream) {\n      this._stopStream(localStream);\n    }\n\n    if (!this._sender) {\n      this._sender = this.version.pc.getSenders()[0];\n    }\n\n    return this._sender.replaceTrack(newStream.getAudioTracks()[0]).then(function () {\n      _this2._updateInputStreamSource(newStream);\n      return getStreamPromise();\n    });\n  }\n\n  return getStreamPromise();\n};\n\nPeerConnection.prototype._onInputDevicesChanged = function () {\n  if (!this.stream) {\n    return;\n  }\n\n  // If all of our active tracks are ended, then our active input was lost\n  var activeInputWasLost = this.stream.getAudioTracks().every(function (track) {\n    return track.readyState === 'ended';\n  });\n\n  // We only want to act if we manage the stream in PeerConnection (It was created\n  // here, rather than passed in.)\n  if (activeInputWasLost && this._shouldManageStream) {\n    this.openWithConstraints(true);\n  }\n};\n\nPeerConnection.prototype._onIceGatheringFailure = function (type) {\n  this._hasIceGatheringFailures = true;\n  this.onicegatheringfailure(type);\n};\n\nPeerConnection.prototype._onMediaConnectionStateChange = function (newState) {\n  var previousState = this._iceState;\n\n  if (previousState === newState || newState !== 'connected' && newState !== 'disconnected' && newState !== 'failed') {\n    return;\n  }\n  this._iceState = newState;\n\n  var message = void 0;\n  switch (newState) {\n    case 'connected':\n      if (previousState === 'disconnected' || previousState === 'failed') {\n        message = 'ICE liveliness check succeeded. Connection with Twilio restored';\n        this._log.info(message);\n        this.onreconnected(message);\n      } else {\n        message = 'Media connection established.';\n        this._log.info(message);\n        this.onconnected(message);\n      }\n      this._stopIceGatheringTimeout();\n      this._hasIceGatheringFailures = false;\n      break;\n    case 'disconnected':\n      message = 'ICE liveliness check failed. May be having trouble connecting to Twilio';\n      this._log.info(message);\n      this.ondisconnected(message);\n      break;\n    case 'failed':\n      message = 'Connection with Twilio was interrupted.';\n      this._log.info(message);\n      this.onfailed(message);\n      break;\n  }\n};\n\nPeerConnection.prototype._setSinkIds = function (sinkIds) {\n  if (!this._isSinkSupported) {\n    return Promise.reject(new NotSupportedError('Audio output selection is not supported by this browser'));\n  }\n\n  this.sinkIds = new Set(sinkIds.forEach ? sinkIds : [sinkIds]);\n  return this.version ? this._updateAudioOutputs() : Promise.resolve();\n};\n\n/**\n * Start timeout for ICE Gathering\n */\nPeerConnection.prototype._startIceGatheringTimeout = function startIceGatheringTimeout() {\n  var _this3 = this;\n\n  this._stopIceGatheringTimeout();\n  this._iceGatheringTimeoutId = setTimeout(function () {\n    _this3._onIceGatheringFailure(ICE_GATHERING_FAIL_TIMEOUT);\n  }, ICE_GATHERING_TIMEOUT);\n};\n\n/**\n * Stop timeout for ICE Gathering\n */\nPeerConnection.prototype._stopIceGatheringTimeout = function stopIceGatheringTimeout() {\n  clearInterval(this._iceGatheringTimeoutId);\n};\n\nPeerConnection.prototype._updateAudioOutputs = function updateAudioOutputs() {\n  var addedOutputIds = Array.from(this.sinkIds).filter(function (id) {\n    return !this.outputs.has(id);\n  }, this);\n\n  var removedOutputIds = Array.from(this.outputs.keys()).filter(function (id) {\n    return !this.sinkIds.has(id);\n  }, this);\n\n  var self = this;\n  var createOutputPromises = addedOutputIds.map(this._createAudioOutput, this);\n  return Promise.all(createOutputPromises).then(function () {\n    return Promise.all(removedOutputIds.map(self._removeAudioOutput, self));\n  });\n};\n\nPeerConnection.prototype._createAudio = function createAudio(arr) {\n  return new Audio(arr);\n};\n\nPeerConnection.prototype._createAudioOutput = function createAudioOutput(id) {\n  var dest = this._audioContext.createMediaStreamDestination();\n  this._mediaStreamSource.connect(dest);\n\n  var audio = this._createAudio();\n  setAudioSource(audio, dest.stream);\n\n  var self = this;\n  return audio.setSinkId(id).then(function () {\n    return audio.play();\n  }).then(function () {\n    self.outputs.set(id, {\n      audio: audio,\n      dest: dest\n    });\n  });\n};\n\nPeerConnection.prototype._removeAudioOutputs = function removeAudioOutputs() {\n  if (this._masterAudio && typeof this._masterAudioDeviceId !== 'undefined') {\n    this._disableOutput(this, this._masterAudioDeviceId);\n    this.outputs.delete(this._masterAudioDeviceId);\n    this._masterAudioDeviceId = null;\n\n    // Release the audio resources before deleting the audio\n    if (!this._masterAudio.paused) {\n      this._masterAudio.pause();\n    }\n    if (typeof this._masterAudio.srcObject !== 'undefined') {\n      this._masterAudio.srcObject = null;\n    } else {\n      this._masterAudio.src = '';\n    }\n    this._masterAudio = null;\n  }\n\n  return Array.from(this.outputs.keys()).map(this._removeAudioOutput, this);\n};\n\nPeerConnection.prototype._disableOutput = function disableOutput(pc, id) {\n  var output = pc.outputs.get(id);\n  if (!output) {\n    return;\n  }\n\n  if (output.audio) {\n    output.audio.pause();\n    output.audio.src = '';\n  }\n\n  if (output.dest) {\n    output.dest.disconnect();\n  }\n};\n\n/**\n * Disable a non-master output, and update the master output to assume its state. This\n *   is called when the device ID assigned to the master output has been removed from\n *   active devices. We can not simply remove the master audio output, so we must\n *   instead reassign it.\n * @private\n * @param {PeerConnection} pc\n * @param {string} masterId - The current device ID assigned to the master audio element.\n */\nPeerConnection.prototype._reassignMasterOutput = function reassignMasterOutput(pc, masterId) {\n  var masterOutput = pc.outputs.get(masterId);\n  pc.outputs.delete(masterId);\n\n  var self = this;\n  var idToReplace = Array.from(pc.outputs.keys())[0] || 'default';\n  return masterOutput.audio.setSinkId(idToReplace).then(function () {\n    self._disableOutput(pc, idToReplace);\n\n    pc.outputs.set(idToReplace, masterOutput);\n    pc._masterAudioDeviceId = idToReplace;\n  }).catch(function rollback() {\n    pc.outputs.set(masterId, masterOutput);\n    self._log.info('Could not reassign master output. Attempted to roll back.');\n  });\n};\n\nPeerConnection.prototype._removeAudioOutput = function removeAudioOutput(id) {\n  if (this._masterAudioDeviceId === id) {\n    return this._reassignMasterOutput(this, id);\n  }\n\n  this._disableOutput(this, id);\n  this.outputs.delete(id);\n\n  return Promise.resolve();\n};\n\n/**\n * Use an AudioContext to potentially split our audio output stream to multiple\n *   audio devices. This is only available to browsers with AudioContext and\n *   HTMLAudioElement.setSinkId() available. We save the source stream in\n *   _masterAudio, and use it for one of the active audio devices. We keep\n *   track of its ID because we must replace it if we lose its initial device.\n */\nPeerConnection.prototype._onAddTrack = function onAddTrack(pc, stream) {\n  var audio = pc._masterAudio = this._createAudio();\n  setAudioSource(audio, stream);\n  audio.play();\n\n  // Assign the initial master audio element to a random active output device\n  var deviceId = Array.from(pc.outputs.keys())[0] || 'default';\n  pc._masterAudioDeviceId = deviceId;\n  pc.outputs.set(deviceId, {\n    audio: audio\n  });\n\n  pc._mediaStreamSource = pc._audioContext.createMediaStreamSource(stream);\n\n  pc.pcStream = stream;\n  pc._updateAudioOutputs();\n};\n\n/**\n * Use a single audio element to play the audio output stream. This does not\n *   support multiple output devices, and is a fallback for when AudioContext\n *   and/or HTMLAudioElement.setSinkId() is not available to the client.\n */\nPeerConnection.prototype._fallbackOnAddTrack = function fallbackOnAddTrack(pc, stream) {\n  var audio = document && document.createElement('audio');\n  audio.autoplay = true;\n\n  if (!setAudioSource(audio, stream)) {\n    pc._log.info('Error attaching stream to element.');\n  }\n\n  pc.outputs.set('default', {\n    audio: audio\n  });\n};\n\nPeerConnection.prototype._setEncodingParameters = function (enableDscp) {\n  if (!enableDscp || !this._sender || typeof this._sender.getParameters !== 'function' || typeof this._sender.setParameters !== 'function') {\n    return;\n  }\n\n  var params = this._sender.getParameters();\n  if (!params.priority && !(params.encodings && params.encodings.length)) {\n    return;\n  }\n\n  // This is how MDN's RTPSenderParameters defines priority\n  params.priority = 'high';\n\n  // And this is how it's currently implemented in Chrome M72+\n  if (params.encodings && params.encodings.length) {\n    params.encodings.forEach(function (encoding) {\n      encoding.priority = 'high';\n      encoding.networkPriority = 'high';\n    });\n  }\n\n  this._sender.setParameters(params);\n};\n\nPeerConnection.prototype._setupPeerConnection = function (rtcConstraints, rtcConfiguration) {\n  var _this4 = this;\n\n  var self = this;\n  var version = new (this.options.rtcpcFactory || RTCPC)();\n  version.create(rtcConstraints, rtcConfiguration);\n  addStream(version.pc, this.stream);\n\n  var eventName = 'ontrack' in version.pc ? 'ontrack' : 'onaddstream';\n\n  version.pc[eventName] = function (event) {\n    var stream = self._remoteStream = event.stream || event.streams[0];\n\n    if (typeof version.pc.getSenders === 'function') {\n      _this4._sender = version.pc.getSenders()[0];\n    }\n\n    if (self._isSinkSupported) {\n      self._onAddTrack(self, stream);\n    } else {\n      self._fallbackOnAddTrack(self, stream);\n    }\n\n    self._startPollingVolume();\n  };\n  return version;\n};\n\nPeerConnection.prototype._maybeSetIceAggressiveNomination = function (sdp) {\n  return this.options.forceAggressiveIceNomination ? setIceAggressiveNomination(sdp) : sdp;\n};\n\nPeerConnection.prototype._setupChannel = function () {\n  var _this5 = this;\n\n  var pc = this.version.pc;\n\n  // Chrome 25 supports onopen\n  this.version.pc.onopen = function () {\n    _this5.status = 'open';\n    _this5.onopen();\n  };\n\n  // Chrome 26 doesn't support onopen so must detect state change\n  this.version.pc.onstatechange = function () {\n    if (_this5.version.pc && _this5.version.pc.readyState === 'stable') {\n      _this5.status = 'open';\n      _this5.onopen();\n    }\n  };\n\n  // Chrome 27 changed onstatechange to onsignalingstatechange\n  this.version.pc.onsignalingstatechange = function () {\n    var state = pc.signalingState;\n    _this5._log.info('signalingState is \"' + state + '\"');\n\n    if (_this5.version.pc && _this5.version.pc.signalingState === 'stable') {\n      _this5.status = 'open';\n      _this5.onopen();\n    }\n\n    _this5.onsignalingstatechange(pc.signalingState);\n  };\n\n  // Chrome 72+\n  pc.onconnectionstatechange = function () {\n    _this5._log.info('pc.connectionState is \"' + pc.connectionState + '\"');\n    _this5.onpcconnectionstatechange(pc.connectionState);\n    _this5._onMediaConnectionStateChange(pc.connectionState);\n  };\n\n  pc.onicecandidate = function (event) {\n    var candidate = event.candidate;\n\n    if (candidate) {\n      _this5._hasIceCandidates = true;\n      _this5.onicecandidate(candidate);\n      _this5._setupRTCIceTransportListener();\n    }\n\n    _this5._log.info('ICE Candidate: ' + JSON.stringify(candidate));\n  };\n\n  pc.onicegatheringstatechange = function () {\n    var state = pc.iceGatheringState;\n    if (state === 'gathering') {\n      _this5._startIceGatheringTimeout();\n    } else if (state === 'complete') {\n      _this5._stopIceGatheringTimeout();\n\n      // Fail if no candidates found\n      if (!_this5._hasIceCandidates) {\n        _this5._onIceGatheringFailure(ICE_GATHERING_FAIL_NONE);\n      }\n\n      // There was a failure mid-gathering phase. We want to start our timer and issue\n      // an ice restart if we don't get connected after our timeout\n      if (_this5._hasIceCandidates && _this5._hasIceGatheringFailures) {\n        _this5._startIceGatheringTimeout();\n      }\n    }\n\n    _this5._log.info('pc.iceGatheringState is \"' + pc.iceGatheringState + '\"');\n    _this5.onicegatheringstatechange(state);\n  };\n\n  pc.oniceconnectionstatechange = function () {\n    _this5._log.info('pc.iceConnectionState is \"' + pc.iceConnectionState + '\"');\n    _this5.oniceconnectionstatechange(pc.iceConnectionState);\n    _this5._onMediaConnectionStateChange(pc.iceConnectionState);\n  };\n};\nPeerConnection.prototype._initializeMediaStream = function (rtcConstraints, rtcConfiguration) {\n  // if mediastream already open then do nothing\n  if (this.status === 'open') {\n    return false;\n  }\n  if (this.pstream.status === 'disconnected') {\n    this.onerror({ info: {\n        code: 31000,\n        message: 'Cannot establish connection. Client is disconnected',\n        twilioError: new SignalingErrors.ConnectionDisconnected()\n      } });\n    this.close();\n    return false;\n  }\n  this.version = this._setupPeerConnection(rtcConstraints, rtcConfiguration);\n  this._setupChannel();\n  return true;\n};\n\n/**\n * Remove reconnection-related listeners\n * @private\n */\nPeerConnection.prototype._removeReconnectionListeners = function () {\n  if (this.pstream) {\n    this.pstream.removeListener('answer', this._onAnswerOrRinging);\n    this.pstream.removeListener('hangup', this._onHangup);\n  }\n};\n\n/**\n * Setup a listener for RTCDtlsTransport to capture state changes events\n * @private\n */\nPeerConnection.prototype._setupRTCDtlsTransportListener = function () {\n  var _this6 = this;\n\n  var dtlsTransport = this.getRTCDtlsTransport();\n\n  if (!dtlsTransport || dtlsTransport.onstatechange) {\n    return;\n  }\n\n  var handler = function handler() {\n    _this6._log.info('dtlsTransportState is \"' + dtlsTransport.state + '\"');\n    _this6.ondtlstransportstatechange(dtlsTransport.state);\n  };\n\n  // Publish initial state\n  handler();\n  dtlsTransport.onstatechange = handler;\n};\n\n/**\n * Setup a listener for RTCIceTransport to capture selected candidate pair changes\n * @private\n */\nPeerConnection.prototype._setupRTCIceTransportListener = function () {\n  var _this7 = this;\n\n  var iceTransport = this._getRTCIceTransport();\n\n  if (!iceTransport || iceTransport.onselectedcandidatepairchange) {\n    return;\n  }\n\n  iceTransport.onselectedcandidatepairchange = function () {\n    return _this7.onselectedcandidatepairchange(iceTransport.getSelectedCandidatePair());\n  };\n};\n\n/**\n * Restarts ICE for the current connection\n * ICE Restart failures are ignored. Retries are managed in Connection\n * @private\n */\nPeerConnection.prototype.iceRestart = function () {\n  var _this8 = this;\n\n  if (!this.options.enableIceRestart) {\n    return;\n  }\n  this._log.info('Attempting to restart ICE...');\n  this._hasIceCandidates = false;\n  this.version.createOffer(this.options.maxAverageBitrate, this.codecPreferences, { iceRestart: true }).then(function () {\n    _this8._removeReconnectionListeners();\n\n    _this8._onAnswerOrRinging = function (payload) {\n      _this8._removeReconnectionListeners();\n\n      if (!payload.sdp || _this8.version.pc.signalingState !== 'have-local-offer') {\n        var message = 'Invalid state or param during ICE Restart:' + ('hasSdp:' + !!payload.sdp + ', signalingState:' + _this8.version.pc.signalingState);\n        _this8._log.info(message);\n        return;\n      }\n\n      var sdp = _this8._maybeSetIceAggressiveNomination(payload.sdp);\n      _this8._answerSdp = sdp;\n      if (_this8.status !== 'closed') {\n        _this8.version.processAnswer(_this8.codecPreferences, sdp, null, function (err) {\n          var message = err && err.message ? err.message : err;\n          _this8._log.info('Failed to process answer during ICE Restart. Error: ' + message);\n        });\n      }\n    };\n\n    _this8._onHangup = function () {\n      _this8._log.info('Received hangup during ICE Restart');\n      _this8._removeReconnectionListeners();\n    };\n\n    _this8.pstream.on('answer', _this8._onAnswerOrRinging);\n    _this8.pstream.on('hangup', _this8._onHangup);\n    _this8.pstream.reinvite(_this8.version.getSDP(), _this8.callSid);\n  }).catch(function (err) {\n    var message = err && err.message ? err.message : err;\n    _this8._log.info('Failed to createOffer during ICE Restart. Error: ' + message);\n    // CreateOffer failures doesn't transition ice state to failed\n    // We need trigger it so it can be picked up by retries\n    _this8.onfailed(message);\n  });\n};\n\nPeerConnection.prototype.makeOutgoingCall = function (token, params, callsid, rtcConstraints, rtcConfiguration, onMediaStarted) {\n  var _this9 = this;\n\n  if (!this._initializeMediaStream(rtcConstraints, rtcConfiguration)) {\n    return;\n  }\n\n  var self = this;\n  this.callSid = callsid;\n  function onAnswerSuccess() {\n    if (self.options) {\n      self._setEncodingParameters(self.options.dscp);\n    }\n    onMediaStarted(self.version.pc);\n  }\n  function onAnswerError(err) {\n    var errMsg = err.message || err;\n    self.onerror({ info: {\n        code: 31000,\n        message: 'Error processing answer: ' + errMsg,\n        twilioError: new MediaErrors.ClientRemoteDescFailed()\n      } });\n  }\n  this._onAnswerOrRinging = function (payload) {\n    if (!payload.sdp) {\n      return;\n    }\n\n    var sdp = _this9._maybeSetIceAggressiveNomination(payload.sdp);\n    self._answerSdp = sdp;\n    if (self.status !== 'closed') {\n      self.version.processAnswer(_this9.codecPreferences, sdp, onAnswerSuccess, onAnswerError);\n    }\n    self.pstream.removeListener('answer', self._onAnswerOrRinging);\n    self.pstream.removeListener('ringing', self._onAnswerOrRinging);\n  };\n  this.pstream.on('answer', this._onAnswerOrRinging);\n  this.pstream.on('ringing', this._onAnswerOrRinging);\n\n  function onOfferSuccess() {\n    if (self.status !== 'closed') {\n      self.pstream.invite(self.version.getSDP(), self.callSid, self.options.preflight, params);\n      self._setupRTCDtlsTransportListener();\n    }\n  }\n\n  function onOfferError(err) {\n    var errMsg = err.message || err;\n    self.onerror({ info: {\n        code: 31000,\n        message: 'Error creating the offer: ' + errMsg,\n        twilioError: new MediaErrors.ClientLocalDescFailed()\n      } });\n  }\n\n  this.version.createOffer(this.options.maxAverageBitrate, this.codecPreferences, { audio: true }, onOfferSuccess, onOfferError);\n};\nPeerConnection.prototype.answerIncomingCall = function (callSid, sdp, rtcConstraints, rtcConfiguration, onMediaStarted) {\n  if (!this._initializeMediaStream(rtcConstraints, rtcConfiguration)) {\n    return;\n  }\n  sdp = this._maybeSetIceAggressiveNomination(sdp);\n  this._answerSdp = sdp.replace(/^a=setup:actpass$/gm, 'a=setup:passive');\n  this.callSid = callSid;\n  var self = this;\n  function onAnswerSuccess() {\n    if (self.status !== 'closed') {\n      self.pstream.answer(self.version.getSDP(), callSid);\n      if (self.options) {\n        self._setEncodingParameters(self.options.dscp);\n      }\n      onMediaStarted(self.version.pc);\n      self._setupRTCDtlsTransportListener();\n    }\n  }\n  function onAnswerError(err) {\n    var errMsg = err.message || err;\n    self.onerror({ info: {\n        code: 31000,\n        message: 'Error creating the answer: ' + errMsg,\n        twilioError: new MediaErrors.ClientRemoteDescFailed()\n      } });\n  }\n  this.version.processSDP(this.options.maxAverageBitrate, this.codecPreferences, sdp, { audio: true }, onAnswerSuccess, onAnswerError);\n};\nPeerConnection.prototype.close = function () {\n  if (this.version && this.version.pc) {\n    if (this.version.pc.signalingState !== 'closed') {\n      this.version.pc.close();\n    }\n\n    this.version.pc = null;\n  }\n  if (this.stream) {\n    this.mute(false);\n    this._stopStream(this.stream);\n  }\n  this.stream = null;\n  this._removeReconnectionListeners();\n  this._stopIceGatheringTimeout();\n\n  Promise.all(this._removeAudioOutputs()).catch(function () {\n    // We don't need to alert about failures here.\n  });\n  if (this._mediaStreamSource) {\n    this._mediaStreamSource.disconnect();\n  }\n  if (this._inputAnalyser) {\n    this._inputAnalyser.disconnect();\n  }\n  if (this._outputAnalyser) {\n    this._outputAnalyser.disconnect();\n  }\n  if (this._inputAnalyser2) {\n    this._inputAnalyser2.disconnect();\n  }\n  if (this._outputAnalyser2) {\n    this._outputAnalyser2.disconnect();\n  }\n  this.status = 'closed';\n  this.onclose();\n};\nPeerConnection.prototype.reject = function (callSid) {\n  this.callSid = callSid;\n};\nPeerConnection.prototype.ignore = function (callSid) {\n  this.callSid = callSid;\n};\n/**\n * Mute or unmute input audio. If the stream is not yet present, the setting\n *   is saved and applied to future streams/tracks.\n * @params {boolean} shouldMute - Whether the input audio should\n *   be muted or unmuted.\n */\nPeerConnection.prototype.mute = function (shouldMute) {\n  this.isMuted = shouldMute;\n  if (!this.stream) {\n    return;\n  }\n\n  if (this._sender && this._sender.track) {\n    this._sender.track.enabled = !shouldMute;\n  } else {\n    var audioTracks = typeof this.stream.getAudioTracks === 'function' ? this.stream.getAudioTracks() : this.stream.audioTracks;\n\n    audioTracks.forEach(function (track) {\n      track.enabled = !shouldMute;\n    });\n  }\n};\n/**\n * Get or create an RTCDTMFSender for the first local audio MediaStreamTrack\n * we can get from the RTCPeerConnection. Return null if unsupported.\n * @instance\n * @returns ?RTCDTMFSender\n */\nPeerConnection.prototype.getOrCreateDTMFSender = function getOrCreateDTMFSender() {\n  if (this._dtmfSender || this._dtmfSenderUnsupported) {\n    return this._dtmfSender || null;\n  }\n\n  var self = this;\n  var pc = this.version.pc;\n  if (!pc) {\n    this._log.info('No RTCPeerConnection available to call createDTMFSender on');\n    return null;\n  }\n\n  if (typeof pc.getSenders === 'function' && (typeof RTCDTMFSender === 'function' || typeof RTCDtmfSender === 'function')) {\n    var chosenSender = pc.getSenders().find(function (sender) {\n      return sender.dtmf;\n    });\n    if (chosenSender) {\n      this._log.info('Using RTCRtpSender#dtmf');\n      this._dtmfSender = chosenSender.dtmf;\n      return this._dtmfSender;\n    }\n  }\n\n  if (typeof pc.createDTMFSender === 'function' && typeof pc.getLocalStreams === 'function') {\n    var track = pc.getLocalStreams().map(function (stream) {\n      var tracks = self._getAudioTracks(stream);\n      return tracks && tracks[0];\n    })[0];\n\n    if (!track) {\n      this._log.info('No local audio MediaStreamTrack available on the RTCPeerConnection to pass to createDTMFSender');\n      return null;\n    }\n\n    this._log.info('Creating RTCDTMFSender');\n    this._dtmfSender = pc.createDTMFSender(track);\n    return this._dtmfSender;\n  }\n\n  this._log.info('RTCPeerConnection does not support RTCDTMFSender');\n  this._dtmfSenderUnsupported = true;\n  return null;\n};\n\n/**\n * Get the RTCDtlTransport object from the PeerConnection\n * @returns RTCDtlTransport\n */\nPeerConnection.prototype.getRTCDtlsTransport = function getRTCDtlsTransport() {\n  var sender = this.version && this.version.pc && typeof this.version.pc.getSenders === 'function' && this.version.pc.getSenders()[0];\n  return sender && sender.transport || null;\n};\n\nPeerConnection.prototype._canStopMediaStreamTrack = function () {\n  return typeof MediaStreamTrack.prototype.stop === 'function';\n};\n\nPeerConnection.prototype._getAudioTracks = function (stream) {\n  return typeof stream.getAudioTracks === 'function' ? stream.getAudioTracks() : stream.audioTracks;\n};\n\n/**\n * Get the RTCIceTransport object from the PeerConnection\n * @returns RTCIceTransport\n */\nPeerConnection.prototype._getRTCIceTransport = function _getRTCIceTransport() {\n  var dtlsTransport = this.getRTCDtlsTransport();\n  return dtlsTransport && dtlsTransport.iceTransport || null;\n};\n\n// Is PeerConnection.protocol used outside of our SDK? We should remove this if not.\nPeerConnection.protocol = function () {\n  return RTCPC.test() ? new RTCPC() : null;\n}();\n\nfunction addStream(pc, stream) {\n  if (typeof pc.addTrack === 'function') {\n    stream.getAudioTracks().forEach(function (track) {\n      // The second parameters, stream, should not be necessary per the latest editor's\n      //   draft, but FF requires it. https://bugzilla.mozilla.org/show_bug.cgi?id=1231414\n      pc.addTrack(track, stream);\n    });\n  } else {\n    pc.addStream(stream);\n  }\n}\n\nfunction cloneStream(oldStream) {\n  var newStream = typeof MediaStream !== 'undefined' ? new MediaStream()\n  // eslint-disable-next-line\n  : new webkitMediaStream();\n\n  oldStream.getAudioTracks().forEach(newStream.addTrack, newStream);\n  return newStream;\n}\n\nfunction removeStream(pc, stream) {\n  if (typeof pc.removeTrack === 'function') {\n    pc.getSenders().forEach(function (sender) {\n      pc.removeTrack(sender);\n    });\n  } else {\n    pc.removeStream(stream);\n  }\n}\n\n/**\n * Set the source of an HTMLAudioElement to the specified MediaStream\n * @param {HTMLAudioElement} audio\n * @param {MediaStream} stream\n * @returns {boolean} Whether the audio source was set successfully\n */\nfunction setAudioSource(audio, stream) {\n  if (typeof audio.srcObject !== 'undefined') {\n    audio.srcObject = stream;\n  } else if (typeof audio.mozSrcObject !== 'undefined') {\n    audio.mozSrcObject = stream;\n  } else if (typeof audio.src !== 'undefined') {\n    var _window = audio.options.window || window;\n    audio.src = (_window.URL || _window.webkitURL).createObjectURL(stream);\n  } else {\n    return false;\n  }\n\n  return true;\n}\n\nPeerConnection.enabled = RTCPC.test();\n\nmodule.exports = PeerConnection;"]},"metadata":{},"sourceType":"script"}