{"ast":null,"code":"var _jsxFileName = \"/root/twilio-phone-client/src/components/MsgCanvas.js\";\nimport React, { Component } from 'react';\nimport styled from 'styled-components';\nimport MsgContactList from './MsgContactList';\nimport MsgContactAdd from './MsgContactAdd';\nimport MsgList from './MsgList';\nimport MsgComposer from './MsgComposer';\nimport Spinner from './Spinner';\nimport MsgContactHeader from './MsgContactHeader';\nconst msgsPerPage = 30;\nexport default class CanvasMsg extends Component {\n  constructor(props) {\n    super(props);\n\n    this.selectContact = selectedContact => {\n      this.setState({\n        selectedContact\n      });\n\n      if (selectedContact !== null) {\n        this.fetchMsgsForContact(selectedContact); // async fetch data for selected contact\n\n        this.props.client.getChannelByUniqueName(selectedContact).then(channel => {\n          // mark all messages as read\n          channel.setAllMessagesConsumed().then(() => {\n            // when done, update cache as well\n            this.props.setUnreadsCache(selectedContact, 0);\n          });\n        });\n      }\n    };\n\n    this.deleteThread = contact => {\n      this.props.client.getChannelByUniqueName(contact).then(channel => {\n        // mark all messages as read\n        channel.delete();\n        this.fetchTracker[contact] = false;\n        delete this.msgAddedHandlerTracker[contact];\n      });\n    };\n\n    this.fetchAnotherPage = () => {\n      return new Promise((resolve, reject) => {\n        const contact = this.state.selectedContact;\n\n        if (contact === 'new') {\n          return;\n        }\n\n        const paginator = this.props.msgPgtrCache[contact];\n\n        if (!paginator.hasPrevPage) {\n          reject('No more messages.');\n        } else {\n          paginator.prevPage().then(paginator => {\n            let messages = [];\n            paginator.items.forEach(msg => {\n              messages.push(msg);\n            });\n            this.props.addMsgCachePage(contact, messages, paginator);\n            resolve();\n          });\n        }\n      });\n    };\n\n    this.msgAddedHandler = (contact, msg) => {\n      this.props.addMsgCacheMsg(contact, msg);\n\n      if ( // if we're the originator of the message, it means we've read it\n      // (this ensures messages originating from this client don't count as unread)\n      msg.state.author === 'us' || // or same thing if user has the thread the message belongs to currently opened\n      contact === this.state.selectedContact) {\n        this.props.channelList[contact].updateLastConsumedMessageIndex(msg.state.index).then(() => {\n          this.props.setUnreadMsgs(this.props.channelList[contact], contact);\n        });\n      } else {\n        this.props.setUnreadMsgs(this.props.channelList[contact], contact);\n      }\n    };\n\n    this.fetchMsgsForContact = contact => {\n      if (contact === 'new') {\n        return;\n      }\n\n      if (this.props.msgCache[contact] === undefined && !this.fetchTracker[contact]) {\n        this.fetchTracker[contact] = true; // prevent double-fetching\n\n        this.props.client.getChannelByUniqueName(contact).then(channel => {\n          // first fetch existing messages\n          channel.getMessages(msgsPerPage).then(paginator => {\n            let messages = [];\n            paginator.items.forEach(msg => {\n              messages.push(msg);\n            });\n            this.props.setMsgCachePage(contact, messages, paginator);\n            this.props.setUnreadMsgs(channel, contact);\n          }); // then subscribe for receiving new messages\n\n          if (!this.msgAddedHandlerTracker[contact]) {\n            this.msgAddedHandlerTracker[contact] = true;\n            channel.on('messageAdded', this.msgAddedHandler.bind(null, contact));\n          }\n        });\n      }\n    };\n\n    this.updateNewPhoneNumber = e => {\n      if (e && e.target) {\n        this.setState({\n          newPhoneNumber: e.target.value\n        });\n      } else if (e === '') {\n        // for resets after sending message in MsgComposer\n        this.setState({\n          newPhoneNumber: ''\n        });\n      }\n    };\n\n    this.msgAddedHandlerTracker = {};\n    this.fetchTracker = {};\n    this.state = {\n      selectedContact: null,\n      newPhoneNumber: ''\n    };\n  }\n\n  componentDidMount() {\n    if (this.props.channelList) {\n      Object.keys(this.props.channelList).forEach(contact => {\n        this.fetchMsgsForContact(contact);\n      });\n    }\n  }\n\n  componentDidUpdate() {\n    if (this.props.channelList) {\n      Object.keys(this.props.channelList).forEach(contact => {\n        this.fetchMsgsForContact(contact);\n      });\n    }\n  }\n\n  componentWillUnmount() {\n    // remove all 'messageAdded' event listeners\n    Object.keys(this.msgAddedHandlerTracker).forEach(contact => {\n      this.props.client.getChannelByUniqueName(contact).then(channel => {\n        channel.removeAllListeners('messageAdded');\n      });\n    });\n  }\n\n  render() {\n    if (this.state.selectedContact) {\n      return /*#__PURE__*/React.createElement(Canvas, {\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 155,\n          columnNumber: 9\n        }\n      }, /*#__PURE__*/React.createElement(MsgContactHeader, {\n        key: \"msgContactHeader\",\n        back: this.selectContact.bind(null, null),\n        selectedContact: this.state.selectedContact,\n        newPhoneNumber: this.state.newPhoneNumber,\n        updateNewPhoneNumber: this.updateNewPhoneNumber,\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 156,\n          columnNumber: 11\n        }\n      }), /*#__PURE__*/React.createElement(MsgList, {\n        key: \"msgList\",\n        messages: this.props.msgCache[this.state.selectedContact],\n        fetchAnotherPage: this.fetchAnotherPage,\n        selectedContact: this.state.selectedContact,\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 163,\n          columnNumber: 11\n        }\n      }), /*#__PURE__*/React.createElement(MsgComposer, {\n        key: \"msgComposer\",\n        secret: this.props.secret,\n        selectedContact: this.state.selectedContact,\n        selectContact: this.selectContact,\n        newPhoneNumber: this.state.newPhoneNumber,\n        updateNewPhoneNumber: this.updateNewPhoneNumber,\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 169,\n          columnNumber: 11\n        }\n      }));\n    } else {\n      if (this.props.channelList === null) {\n        return /*#__PURE__*/React.createElement(Canvas, {\n          __self: this,\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 182,\n            columnNumber: 11\n          }\n        }, /*#__PURE__*/React.createElement(Spinner, {\n          text: \"Loading contacts...\",\n          __self: this,\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 183,\n            columnNumber: 13\n          }\n        }));\n      } else {\n        return /*#__PURE__*/React.createElement(Canvas, {\n          __self: this,\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 188,\n            columnNumber: 11\n          }\n        }, /*#__PURE__*/React.createElement(MsgContactAdd, {\n          key: \"msgContactAdd\",\n          selectContact: this.selectContact,\n          __self: this,\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 189,\n            columnNumber: 13\n          }\n        }), /*#__PURE__*/React.createElement(MsgContactList, {\n          key: \"msgContactList\",\n          msgUnreadsCache: this.props.msgUnreadsCache,\n          client: this.props.client,\n          channelList: this.props.channelList,\n          selectContact: this.selectContact,\n          deleteThread: this.deleteThread,\n          msgCache: this.props.msgCache,\n          unreadsCache: this.props.unreadsCache,\n          __self: this,\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 193,\n            columnNumber: 13\n          }\n        }));\n      }\n    }\n  }\n\n}\nconst Canvas = styled.div`\n  flex-grow: 1;\n\n  display: flex;\n  flex-direction: column;\n  flex-wrap: nowrap;\n  align-items: stretch;\n  height: 100vh;\n  max-width: 440px;\n  position: relative;\n  overflow-x: hidden;\n`;","map":{"version":3,"sources":["/root/twilio-phone-client/src/components/MsgCanvas.js"],"names":["React","Component","styled","MsgContactList","MsgContactAdd","MsgList","MsgComposer","Spinner","MsgContactHeader","msgsPerPage","CanvasMsg","constructor","props","selectContact","selectedContact","setState","fetchMsgsForContact","client","getChannelByUniqueName","then","channel","setAllMessagesConsumed","setUnreadsCache","deleteThread","contact","delete","fetchTracker","msgAddedHandlerTracker","fetchAnotherPage","Promise","resolve","reject","state","paginator","msgPgtrCache","hasPrevPage","prevPage","messages","items","forEach","msg","push","addMsgCachePage","msgAddedHandler","addMsgCacheMsg","author","channelList","updateLastConsumedMessageIndex","index","setUnreadMsgs","msgCache","undefined","getMessages","setMsgCachePage","on","bind","updateNewPhoneNumber","e","target","newPhoneNumber","value","componentDidMount","Object","keys","componentDidUpdate","componentWillUnmount","removeAllListeners","render","secret","msgUnreadsCache","unreadsCache","Canvas","div"],"mappings":"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","sourcesContent":["import React, { Component } from 'react';\nimport styled from 'styled-components';\n\nimport MsgContactList from './MsgContactList';\nimport MsgContactAdd from './MsgContactAdd';\nimport MsgList from './MsgList';\nimport MsgComposer from './MsgComposer';\nimport Spinner from './Spinner';\nimport MsgContactHeader from './MsgContactHeader';\n\nconst msgsPerPage = 30;\n\nexport default class CanvasMsg extends Component {\n  constructor(props) {\n    super(props);\n    this.msgAddedHandlerTracker = {};\n    this.fetchTracker = {};\n    this.state = {\n      selectedContact: null,\n      newPhoneNumber: ''\n    };\n  }\n\n  selectContact = (selectedContact) => {\n    this.setState({ selectedContact });\n    if (selectedContact !== null) {\n      this.fetchMsgsForContact(selectedContact); // async fetch data for selected contact\n      this.props.client\n        .getChannelByUniqueName(selectedContact)\n        .then((channel) => {\n          // mark all messages as read\n          channel.setAllMessagesConsumed().then(() => {\n            // when done, update cache as well\n            this.props.setUnreadsCache(selectedContact, 0);\n          });\n        });\n    }\n  };\n\n  deleteThread = (contact) => {\n    this.props.client.getChannelByUniqueName(contact).then((channel) => {\n      // mark all messages as read\n      channel.delete();\n      this.fetchTracker[contact] = false;\n      delete this.msgAddedHandlerTracker[contact];\n    });\n  };\n\n  fetchAnotherPage = () => {\n    return new Promise((resolve, reject) => {\n      const contact = this.state.selectedContact;\n      if (contact === 'new') {\n        return;\n      }\n      const paginator = this.props.msgPgtrCache[contact];\n      if (!paginator.hasPrevPage) {\n        reject('No more messages.');\n      } else {\n        paginator.prevPage().then((paginator) => {\n          let messages = [];\n          paginator.items.forEach((msg) => {\n            messages.push(msg);\n          });\n          this.props.addMsgCachePage(contact, messages, paginator);\n          resolve();\n        });\n      }\n    });\n  };\n\n  componentDidMount() {\n    if (this.props.channelList) {\n      Object.keys(this.props.channelList).forEach((contact) => {\n        this.fetchMsgsForContact(contact);\n      });\n    }\n  }\n\n  componentDidUpdate() {\n    if (this.props.channelList) {\n      Object.keys(this.props.channelList).forEach((contact) => {\n        this.fetchMsgsForContact(contact);\n      });\n    }\n  }\n\n  componentWillUnmount() {\n    // remove all 'messageAdded' event listeners\n    Object.keys(this.msgAddedHandlerTracker).forEach((contact) => {\n      this.props.client.getChannelByUniqueName(contact).then((channel) => {\n        channel.removeAllListeners('messageAdded');\n      });\n    });\n  }\n\n  msgAddedHandler = (contact, msg) => {\n    this.props.addMsgCacheMsg(contact, msg);\n    if (\n      // if we're the originator of the message, it means we've read it\n      // (this ensures messages originating from this client don't count as unread)\n      msg.state.author === 'us' ||\n      // or same thing if user has the thread the message belongs to currently opened\n      contact === this.state.selectedContact\n    ) {\n      this.props.channelList[contact]\n        .updateLastConsumedMessageIndex(msg.state.index)\n        .then(() => {\n          this.props.setUnreadMsgs(this.props.channelList[contact], contact);\n        });\n    } else {\n      this.props.setUnreadMsgs(this.props.channelList[contact], contact);\n    }\n  };\n\n  fetchMsgsForContact = (contact) => {\n    if (contact === 'new') {\n      return;\n    }\n    if (\n      this.props.msgCache[contact] === undefined &&\n      !this.fetchTracker[contact]\n    ) {\n      this.fetchTracker[contact] = true; // prevent double-fetching\n      this.props.client.getChannelByUniqueName(contact).then((channel) => {\n        // first fetch existing messages\n        channel.getMessages(msgsPerPage).then((paginator) => {\n          let messages = [];\n          paginator.items.forEach((msg) => {\n            messages.push(msg);\n          });\n          this.props.setMsgCachePage(contact, messages, paginator);\n          this.props.setUnreadMsgs(channel, contact);\n        });\n        // then subscribe for receiving new messages\n        if (!this.msgAddedHandlerTracker[contact]) {\n          this.msgAddedHandlerTracker[contact] = true;\n          channel.on('messageAdded', this.msgAddedHandler.bind(null, contact));\n        }\n      });\n    }\n  };\n\n  updateNewPhoneNumber = (e) => {\n    if (e && e.target) {\n      this.setState({ newPhoneNumber: e.target.value });\n    } else if (e === '') {\n      // for resets after sending message in MsgComposer\n      this.setState({ newPhoneNumber: '' });\n    }\n  };\n\n  render() {\n    if (this.state.selectedContact) {\n      return (\n        <Canvas>\n          <MsgContactHeader\n            key=\"msgContactHeader\"\n            back={this.selectContact.bind(null, null)}\n            selectedContact={this.state.selectedContact}\n            newPhoneNumber={this.state.newPhoneNumber}\n            updateNewPhoneNumber={this.updateNewPhoneNumber}\n          />\n          <MsgList\n            key=\"msgList\"\n            messages={this.props.msgCache[this.state.selectedContact]}\n            fetchAnotherPage={this.fetchAnotherPage}\n            selectedContact={this.state.selectedContact}\n          />\n          <MsgComposer\n            key=\"msgComposer\"\n            secret={this.props.secret}\n            selectedContact={this.state.selectedContact}\n            selectContact={this.selectContact}\n            newPhoneNumber={this.state.newPhoneNumber}\n            updateNewPhoneNumber={this.updateNewPhoneNumber}\n          />\n        </Canvas>\n      );\n    } else {\n      if (this.props.channelList === null) {\n        return (\n          <Canvas>\n            <Spinner text=\"Loading contacts...\" />\n          </Canvas>\n        );\n      } else {\n        return (\n          <Canvas>\n            <MsgContactAdd\n              key=\"msgContactAdd\"\n              selectContact={this.selectContact}\n            />\n            <MsgContactList\n              key=\"msgContactList\"\n              msgUnreadsCache={this.props.msgUnreadsCache}\n              client={this.props.client}\n              channelList={this.props.channelList}\n              selectContact={this.selectContact}\n              deleteThread={this.deleteThread}\n              msgCache={this.props.msgCache}\n              unreadsCache={this.props.unreadsCache}\n            />\n          </Canvas>\n        );\n      }\n    }\n  }\n}\n\nconst Canvas = styled.div`\n  flex-grow: 1;\n\n  display: flex;\n  flex-direction: column;\n  flex-wrap: nowrap;\n  align-items: stretch;\n  height: 100vh;\n  max-width: 440px;\n  position: relative;\n  overflow-x: hidden;\n`;\n"]},"metadata":{},"sourceType":"module"}